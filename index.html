<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Rugby Command Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-dark: #1e2a38; --header-bg: #1a252f; --accent-yellow: #f1c40f;
            --btn-green: #2ecc71; --btn-blue: #3498db; --btn-red: #e74c3c;
            --btn-orange: #e67e22; --btn-gray: #95a5a6;
            --circle-green: #2ecc71; --circle-blue: #3498db; --circle-red: #ff0000;
            --selected-orange: #f39c12; --tactical-blue: #2980b9; 
            --injured-gray: #bdc3c7; --light-red: #ffcdd2;
            --fr-highlight: #e3f2fd; --treating-red: #ff0000; 
        }

        body {
            margin: 0; font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            background-color: var(--bg-dark); color: #ffffff;
            overflow: hidden; display: flex; flex-direction: column; height: 100vh;
        }

        header {
            background-color: var(--header-bg); padding: 8px 15px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 2px solid #333; height: 65px; box-sizing: border-box;
            position: relative;
        }

        #uncontested-banner {
            display: none; position: absolute; left: 50%; top: 50%;
            transform: translate(-50%, -50%); background-color: #ff0000;
            color: white; font-weight: bold; padding: 5px 15px; font-size: 14px;
            border-radius: 4px; white-space: nowrap; z-index: 10;
        }

        .header-left { display: flex; align-items: center; gap: 20px; }
        #team-name-display { font-size: 22px; font-weight: 900; color: var(--accent-yellow); border-left: 5px solid var(--accent-yellow); padding-left: 15px; }
        #category-display { font-size: 18px; font-weight: bold; color: white; background: rgba(255,255,255,0.1); padding: 4px 12px; border-radius: 4px; }

        .timer-container { position: relative; display: flex; align-items: center; gap: 10px; background: #000; padding: 5px 15px; border-radius: 10px; border: 2px solid #444; }
        #timer-display { font-family: 'Courier New', Courier, monospace; font-size: 42px; color: #00ff00; font-weight: bold; min-width: 130px; text-align: center; cursor: pointer; user-select: none; }
        #start-btn { min-width: 80px; font-weight: 900; border-radius: 5px; border: none; padding: 10px; cursor: pointer; }
        .btn-start-style { background-color: var(--btn-green); color: white; }
        .btn-stop-style { background-color: var(--btn-red); color: white; }

        main { 
            display: grid; grid-template-columns: 310px 310px 310px 1fr; 
            gap: 10px; padding: 10px; flex-grow: 1; height: calc(100vh - 65px); box-sizing: border-box; 
        }

        .column { display: flex; flex-direction: column; gap: 10px; height: 100%; overflow: hidden; }
        .panel-header { padding: 6px; text-align: center; font-weight: bold; font-size: 13px; color: white; height: 30px; box-sizing: border-box; }
        .panel-header.green { background-color: var(--btn-green); }
        .panel-header.blue { background-color: var(--btn-blue); }
        .panel-header.yellow { background-color: var(--accent-yellow); color: black; }

        .list-container { background: white; color: black; border: 1px solid #ccc; overflow-y: auto; box-sizing: border-box; }
        #field-list { height: 550px; }
        #bench-list { height: 295px; }

        .player-row { display: grid; grid-template-columns: 28px 42px 135px 30px 45px 35px; align-items: center; height: 34.5px; border-bottom: 1px solid #eee; padding: 0 2px 0 5px; font-size: 13px; cursor: pointer; background-color: white; color: #000; }
        .player-row.selected { background-color: var(--selected-orange) !important; color: white !important; }
        .player-row.selected * { color: white !important; }
        .player-row.status-treating { color: var(--treating-red) !important; }
        .player-row.status-tactical-out { color: var(--tactical-blue) !important; }
        .player-row.status-injured-out { background-color: var(--injured-gray) !important; color: #7f8c8d !important; cursor: not-allowed; }
        
        .pos-circle { width: 20px; height: 20px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; }
        .field-circle { background-color: var(--circle-green); }
        .bench-circle { background-color: var(--circle-blue); }
        .player-name { font-weight: 900; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Floating Menu */
        #floating-menu {
            display: none; position: fixed; top: 120px; left: calc(50% - 140px);
            width: 280px; background: var(--bg-dark); border-radius: 12px;
            border: 2px solid #444; z-index: 9999; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            touch-action: none;
        }
        #menu-drag-handle {
            padding: 12px; background: #1a252f; cursor: move; text-align: center;
            color: var(--accent-yellow); font-weight: bold; border-radius: 10px 10px 0 0;
            user-select: none; touch-action: none;
        }
        .menu-grid { padding: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .menu-grid button { padding: 12px 5px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; font-size: 12px; }
        #open-menu-btn { position: fixed; bottom: 20px; right: 20px; padding: 15px 35px; background: var(--accent-yellow); color: black; font-weight: 900; border-radius: 40px; border: none; cursor: pointer; z-index: 1000; }

        /* Log/Mgt/Reserve Cards */
        .log-entry { font-size: 12px; padding: 8px; border-bottom: 1px solid #ddd; color: black; }
        .reserve-card { margin: 5px; padding: 8px; border: 2px solid var(--btn-green); border-radius: 8px; background: white; position: relative; color: black; }
        .mgt-card { margin: 5px; padding: 10px; border: 2px solid var(--btn-orange); border-radius: 10px; background: white; color: black; }
        .mgt-timer { font-size: 24px; color: var(--btn-red); font-family: monospace; font-weight: bold; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 15px; border-radius: 12px; width: 310px; color: black; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body onload="init()">

<header>
    <div class="header-left">
        <div id="team-name-display">TEAM NAME</div>
        <div id="category-display">Category: 0/0</div>
    </div>
    <div id="uncontested-banner">アンコンテスト・スクラム</div>
    <div class="header-right" style="display:flex; align-items:center; gap:15px;">
        <div class="timer-container">
            <div id="timer-display">00:00</div>
            <button onclick="toggleTimer()" id="start-btn" class="btn-start-style">START</button>
        </div>
        <button onclick="resetTimer()" style="background:var(--btn-gray); color:white; border:none; padding:8px 12px; border-radius:5px; cursor:pointer;">RESET</button>
    </div>
</header>

<main>
    <div class="column">
        <div class="panel-header green">FIELD (1-15)</div>
        <div id="field-list" class="list-container"></div>
        <div class="panel-header yellow">SETTING</div>
        <div class="list-container" style="padding:10px;">
            <input type="file" id="excel-input" style="display:none" onchange="handleExcel(event)">
            <button onclick="document.getElementById('excel-input').click()" style="width:100%; background:var(--btn-blue); color:white; border:none; padding:8px; border-radius:4px; font-weight:bold; margin-bottom:5px;">LOAD EXCEL</button>
            <button onclick="recordHalfEnd()" style="width:100%; background:var(--btn-orange); color:white; border:none; padding:8px; border-radius:4px; font-weight:bold;">前半終了</button>
        </div>
    </div>
    <div class="column">
        <div class="panel-header blue">BENCH (16-23)</div>
        <div id="bench-list" class="list-container"></div>
        <div class="panel-header yellow">PENALTY LOG</div>
        <div id="penalty-log" class="list-container" style="flex-grow:1;"></div>
    </div>
    <div class="column">
        <div class="panel-header yellow">予約・管理</div>
        <div id="reservation-list" class="list-container" style="height:40%;"></div>
        <div id="management-list" class="list-container" style="flex-grow:1;"></div>
    </div>
    <div class="column">
        <div class="panel-header yellow">LOG</div>
        <div id="main-log" class="list-container" style="flex-grow:1;"></div>
    </div>
</main>

<div id="floating-menu">
    <div id="menu-drag-handle">COMMAND CENTER (スライド移動)</div>
    <div class="menu-grid">
        <button style="background:var(--btn-blue)" onclick="menuAction('戦術交代')">戦術交代</button>
        <button style="background:var(--accent-yellow); color:black" onclick="menuAction('YC')">YC</button>
        <button style="background:#2980b9" onclick="menuAction('負傷交代')">負傷交代</button>
        <button style="background:var(--btn-red)" onclick="menuAction('RC')">RC</button>
        <button style="background:#3498db" onclick="menuAction('出血交代')">出血交代</button>
        <button style="background:#8e44ad" onclick="menuAction('OFR')">OFR</button>
        <button style="background:#2c3e50" onclick="menuAction('HIA')">HIA</button>
        <button style="background:#1abc9c" onclick="menuAction('一時退出')">一時退出</button>
        <button style="background:#5D4037" onclick="menuAction('出血HIA')">出血HIA</button>
        <button style="background:#795548" onclick="menuAction('SWAP')">SWAP</button>
        <button style="background:#555; grid-column: span 2;" onclick="closeMenu()">CLOSE</button>
    </div>
</div>

<button id="open-menu-btn" onclick="openMenu()">COMMAND MENU</button>

<script>
    let seconds = 0, timerInterval = null, selectedIds = [], playersMaster = [], managementTimers = {}, managementSeconds = {};
    let categoryLimit = 4;

    function init() {
        openMenu();
        initDraggable();
        renderLists();
    }

    // --- ドラッグ機能 (タブレット/マウス共通) ---
    function initDraggable() {
        const menu = document.getElementById("floating-menu");
        const handle = document.getElementById("menu-drag-handle");
        let isDragging = false;
        let startX, startY, initialLeft, initialTop;

        const onStart = (e) => {
            isDragging = true;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            startX = clientX;
            startY = clientY;
            
            const rect = menu.getBoundingClientRect();
            initialLeft = rect.left;
            initialTop = rect.top;

            // translateの影響を排除するため、現在の位置を固定
            menu.style.transform = "none";
            menu.style.left = initialLeft + "px";
            menu.style.top = initialTop + "px";
        };

        const onMove = (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const dx = clientX - startX;
            const dy = clientY - startY;

            menu.style.left = (initialLeft + dx) + "px";
            menu.style.top = (initialTop + dy) + "px";
        };

        const onEnd = () => { isDragging = false; };

        handle.addEventListener("mousedown", onStart);
        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onEnd);

        handle.addEventListener("touchstart", onStart, {passive: false});
        document.addEventListener("touchmove", onMove, {passive: false});
        document.addEventListener("touchend", onEnd);
    }

    function openMenu() { document.getElementById('floating-menu').style.display = 'block'; }
    function closeMenu() { document.getElementById('floating-menu').style.display = 'none'; }

    // --- ロジック部分 (指示通り) ---
    function menuAction(type) {
        if (selectedIds.length === 0) return;
        const p1 = playersMaster.find(x => x.id === selectedIds[0]);
        const p2 = selectedIds.length > 1 ? playersMaster.find(x => x.id === selectedIds[1]) : null;
        
        if (selectedIds.length === 1 && !['YC','RC','OFR','負傷交代'].includes(type)) {
            addReservationCard(type + "（退出）", p1, null);
        } else {
            addReservationCard(type, p1, p2);
        }
        clearSelection();
    }

    function addReservationCard(type, outP, inP) {
        const resList = document.getElementById('reservation-list'), rid = Date.now();
        const card = document.createElement('div'); card.className = 'reserve-card'; card.id = `res-${rid}`;
        let outName = outP ? `OUT: No${outP.no} ${outP.name}` : 'OUT: ---';
        let inName = inP ? `IN: No${inP.no} ${inP.name}` : 'IN: 空白';
        
        card.innerHTML = `
            <div style="font-weight:bold; color:var(--btn-green);">【${type}】</div>
            <div style="font-size:11px;">${outName}<br>${inName}</div>
            <button onclick="handleReserveExe('${type}', '${outP?outP.id:''}', '${inP?inP.id:''}', ${rid})" style="margin-top:5px; width:100%; background:var(--btn-green); color:white; border:none; border-radius:3px; cursor:pointer;">実行</button>
        `;
        resList.prepend(card);
    }

    function handleReserveExe(type, outId, inId, rid) {
        const outP = playersMaster.find(x => x.id === outId);
        const inP = playersMaster.find(x => x.id === inId);

        if (type.includes('（退出）')) {
            const originType = type.replace('（退出）','');
            // 出血・HIA等の退出中は赤文字
            if(['出血交代','HIA','出血HIA'].includes(originType)) outP.status = 'status-treating';
            const posIdx = playersMaster.findIndex(p => p.id === outId);
            playersMaster[posIdx] = { id: 'empty'+rid, no: '', name: '-----', cat: '', fr: '', status: 'normal' };
            createMgtCard(originType, outP, null, posIdx + 1, rid);
        } else if (['YC','RC','OFR'].includes(type)) {
            const posIdx = playersMaster.findIndex(p => p.id === outId);
            playersMaster[posIdx] = { id: 'empty'+rid, no: '', name: '-----', cat: '', fr: '', status: 'normal' };
            createMgtCard(type, outP, null, posIdx + 1, rid);
            if(type !== 'RC') addPenaltyLog(type, outP); // PENALTYLOGには戦術・負傷・RCなどは記録しない方針
        } else {
            // 通常の交代(戦術・負傷)・一時交代・SWAP
            const idx1 = playersMaster.findIndex(p => p.id === outId);
            const idx2 = playersMaster.findIndex(p => p.id === inId);
            if (idx1 !== -1 && idx2 !== -1) {
                if (type === '戦術交代') outP.status = 'status-tactical-out';
                else if (type === '負傷交代') outP.status = 'status-injured-out';
                // 一時交代(出血等)やSWAPのOUT/INは黒文字(normal)
                else outP.status = 'normal';
                
                playersMaster[idx1] = inP;
                playersMaster[idx2] = outP;
                if(idx1 < 15) playersMaster[idx1].status = 'normal';
                
                if (['出血交代','HIA','出血HIA','一時退出','SWAP'].includes(type)) {
                    createMgtCard(type, outP, inP, idx1 + 1, rid);
                }
            }
        }
        addLog(type, outP, inP);
        document.getElementById(`res-${rid}`).remove();
        renderLists();
        checkFRConditions();
    }

    function createMgtCard(type, outP, inP, pos, mid) {
        const mList = document.getElementById('management-list');
        const card = document.createElement('div'); card.className = 'mgt-card'; card.id = `mgt-${mid}`;
        let dur = (['YC','OFR'].includes(type)) ? 600 : (type === 'HIA' ? 720 : (type === '出血HIA' ? 1020 : 900));
        managementSeconds[mid] = dur;
        card.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <span style="font-weight:bold; color:var(--btn-orange);">【${type}】</span>
                <span class="mgt-timer" id="timer-${mid}">${formatTimer(dur)}</span>
            </div>
            <div style="font-size:12px; margin:5px 0;">No.${outP.no} ${outP.name}</div>
            <button onclick="executeReturn(${mid}, '${outP.id}', '${inP?inP.id:''}', '${type}')" style="width:100%; background:var(--btn-blue); color:white; border:none; border-radius:3px; padding:5px;">復帰予約</button>
        `;
        mList.prepend(card);
        startMgtTimer(mid, ['出血交代','HIA','出血HIA','一時退出','SWAP'].includes(type));
    }

    function executeReturn(mid, outId, inId, type) {
        const outP = playersMaster.find(x => x.id === outId) || {no:'?', name:'?'};
        const inP = playersMaster.find(x => x.id === inId);
        addReservationCard(type + "（復帰）", inP, outP);
        document.getElementById(`mgt-${mid}`).remove();
        clearInterval(managementTimers[mid]);
    }

    function startMgtTimer(mid, independent) {
        managementTimers[mid] = setInterval(() => {
            if (independent || timerInterval) {
                managementSeconds[mid]--;
                const el = document.getElementById(`timer-${mid}`);
                if (el) el.innerText = formatTimer(managementSeconds[mid]);
                if (managementSeconds[mid] <= 0) clearInterval(managementTimers[mid]);
            }
        }, 1000);
    }

    function renderLists() {
        const f = document.getElementById('field-list'), b = document.getElementById('bench-list');
        f.innerHTML = ''; b.innerHTML = '';
        playersMaster.slice(0, 15).forEach((p, i) => f.innerHTML += createRow(i + 1, p, 'field'));
        playersMaster.slice(15, 23).forEach((p, i) => b.innerHTML += createRow(i + 16, p, 'bench'));
    }

    function createRow(pos, p, type) {
        const statusClass = p.status || 'normal';
        return `<div class="player-row ${statusClass}" onclick="selectPlayer('${p.id}', this)">
            <div class="pos-circle ${type==='field'?'field-circle':'bench-circle'}">${pos}</div>
            <div>${p.no?'No.'+p.no:''}</div>
            <div class="player-name">${p.name}</div>
            <div>${p.cat}</div><div style="font-size:10px; color:var(--btn-orange);">${p.fr}</div><div></div>
        </div>`;
    }

    function selectPlayer(id, el) {
        if (id.startsWith('empty')) return;
        const idx = selectedIds.indexOf(id);
        if (idx > -1) { selectedIds.splice(idx,1); el.classList.remove('selected'); }
        else { selectedIds.push(id); el.classList.add('selected'); }
    }

    function clearSelection() { selectedIds = []; document.querySelectorAll('.player-row').forEach(r => r.classList.remove('selected')); }

    function toggleTimer() {
        const btn = document.getElementById('start-btn');
        if (timerInterval) { clearInterval(timerInterval); timerInterval = null; btn.innerText = "START"; btn.className = "btn-start-style"; }
        else { timerInterval = setInterval(() => { seconds++; updateTimerDisplay(); }, 1000); btn.innerText = "STOP"; btn.className = "btn-stop-style"; }
    }
    function updateTimerDisplay() { document.getElementById('timer-display').innerText = formatTimer(seconds); }
    function formatTimer(s) { const m = Math.floor(s/60).toString().padStart(2,'0'), sec = (s%60).toString().padStart(2,'0'); return `${m}:${sec}`; }
    function resetTimer() { if(confirm("リセット？")) { seconds = 0; updateTimerDisplay(); } }

    function addLog(type, outP, inP) {
        const div = document.createElement('div'); div.className = 'log-entry';
        div.innerHTML = `<b>[${formatTimer(seconds)}] ${type}</b><br>${outP?`OUT: No${outP.no}`:''} ${inP?`IN: No${inP.no}`:''}`;
        document.getElementById('main-log').prepend(div);
    }
    function addPenaltyLog(type, p) {
        const div = document.createElement('div'); div.className = 'log-entry';
        div.style.backgroundColor = type==='RC'?'#ffcdd2':'#fff176';
        div.innerHTML = `<b>[${formatTimer(seconds)}] ${type}</b> No.${p.no} ${p.name}`;
        document.getElementById('penalty-log').prepend(div);
    }

    function checkFRConditions() {
        const p1 = playersMaster[0], p2 = playersMaster[1], p3 = playersMaster[2];
        const ok = p1?.fr.includes('1') && p2?.fr.includes('2') && p3?.fr.includes('3');
        document.getElementById('uncontested-banner').style.display = ok ? 'none' : 'block';
    }

    function handleExcel(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = new Uint8Array(ev.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            const sheet = wb.Sheets[wb.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
            document.getElementById('team-name-display').innerText = json[0] ? json[0][2] : "TEAM";
            playersMaster = [];
            for (let i = 2; i < 25; i++) {
                const r = json[i] || [];
                let fr = []; if(r[3]) fr.push(1); if(r[4]) fr.push(2); if(r[5]) fr.push(3);
                playersMaster.push({ id: 'p'+i, no: r[0]||'', name: r[1]||'-----', cat: r[2]||'', fr: fr.join(' '), status: 'normal' });
            }
            renderLists(); checkFRConditions();
        };
        reader.readAsArrayBuffer(file);
    }

    // 初期化用
    playersMaster = Array.from({length:23}, (_,i)=>({id:'init'+i, no:'', name:'-----', cat:'', fr:'', status:'normal'}));
</script>
</body>
</html>
