<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rugby Sub Manager - Pro Edition</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-header: #1e293b;
            --border-color: #334155;
            --field-green: #10b981;
            --bench-orange: #f59e0b;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --text-medical: #ef4444;
            --text-tactical: #3b82f6;
            --bg-injury: #475569;
            --bg-reserved: #334155;
            --accent-yc: #fbbf24;
            --accent-rc: #ef4444;
            --accent-ofr: #f97316;
        }

        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; user-select: none; }
        
        /* Header */
        header { background: var(--bg-header); padding: 8px 20px; border-bottom: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); flex-shrink: 0; }
        .header-top { display: flex; justify-content: space-between; align-items: center; height: 40px; }
        .stopwatch-container { display: flex; align-items: center; gap: 12px; background: #0f172a; padding: 4px 15px; border-radius: 30px; border: 1px solid var(--border-color); }
        #timer-display { font-family: 'JetBrains Mono', monospace; font-size: 1.6rem; font-weight: 700; color: #10b981; letter-spacing: 1px; }
        .sw-btn { padding: 4px 10px; font-size: 0.75rem; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
        .btn-start { background: var(--field-green); color: white; }
        .btn-pause { background: #64748b; color: white; }
        .btn-reset { background: transparent; color: #ef4444; border: 1px solid #ef4444; }
        .stats-bar { display: flex; gap: 20px; font-size: 0.85rem; margin-top: 8px; color: var(--text-sub); }
        .stats-bar b { color: var(--text-main); }

        /* Main Layout */
        main { display: flex; gap: 10px; padding: 10px; flex-grow: 1; overflow: hidden; }
        .col-field { width: 260px; flex-shrink: 0; }
        .col-bench { width: 260px; flex-shrink: 0; }
        .col-res-admin { width: 340px; flex-shrink: 0; display: flex; flex-direction: column; gap: 10px; }
        .col-log { flex-grow: 1; min-width: 200px; }

        .column { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; height: 100%; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2); }
        h2 { font-size: 0.75rem; margin: 0; padding: 8px; background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border-color); text-align: center; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; }
        .scroll-area { flex-grow: 1; overflow-y: auto; padding: 8px; scrollbar-width: thin; }

        /* Player Cards - FIELD (Narrow) */
        .player-card { height: 32px; margin-bottom: 5px; border: 1px solid var(--border-color); border-radius: 6px; display: flex; align-items: center; background: #2d3748; position: relative; transition: transform 0.1s; }
        .col-bench .player-card { height: 42px; } /* Bench is slightly taller for better touch */
        .is-reserved { border-color: var(--bench-orange) !important; background: var(--bg-reserved) !important; }
        
        .pos-label { width: 24px; height: 100%; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 800; color: var(--text-sub); border-right: 1px solid var(--border-color); border-radius: 6px 0 0 6px; }
        .player-info { flex-grow: 1; padding: 0 8px; display: flex; align-items: center; font-weight: 600; overflow: hidden; gap: 8px; }
        .jersey-no { font-size: 0.85rem; color: var(--field-green); min-width: 20px; }
        .player-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; font-size: 0.8rem; color: var(--text-main); }
        .player-cat { font-size: 0.6rem; color: var(--text-sub); background: rgba(255,255,255,0.1); padding: 1px 4px; border-radius: 3px; }
        .player-fr-num { font-size: 0.7rem; color: #fbbf24; font-weight: 900; }

        /* Reservation & Admin Cards */
        .res-card, .admin-card { background: #1e293b; border: 1px solid #475569; border-left: 4px solid var(--bench-orange); border-radius: 8px; padding: 10px; margin-bottom: 10px; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .admin-card { border-left-color: var(--text-tactical); }
        .btn-delete { position: absolute; top: 4px; right: 4px; width: 20px; height: 20px; background: rgba(239,68,68,0.2); color: #ef4444; border: none; border-radius: 50%; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .res-header { font-weight: 800; font-size: 0.8rem; border-bottom: 1px solid var(--border-color); margin-bottom: 8px; padding-bottom: 4px; display: flex; justify-content: space-between; color: var(--text-sub); }
        
        .res-player-line { display: flex; flex-direction: column; gap: 2px; margin: 5px 0; }
        .line-row { display: flex; align-items: center; font-size: 0.9rem; }
        .line-label { font-size: 0.6rem; width: 30px; color: var(--text-sub); font-weight: bold; }
        .res-no { color: var(--field-green); font-weight: bold; margin-right: 5px; }

        .res-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 10px; }
        .res-actions button { padding: 6px 2px; font-size: 0.75rem; font-weight: 700; border-radius: 4px; border: 1px solid var(--border-color); background: #334155; color: white; cursor: pointer; }
        .btn-execute-large { grid-column: span 3; padding: 10px !important; background: var(--field-green) !important; color: white !important; font-size: 1rem !important; margin-top: 5px; border: none !important; }

        /* Status Colors */
        .status-medical { color: var(--accent-rc) !important; }
        .status-tactical { color: var(--text-tactical) !important; }
        .status-injury { background-color: var(--bg-injury) !important; opacity: 0.7; }
        .status-yc { background-color: var(--accent-yc) !important; color: #000 !important; }
        .status-ofr { background-color: var(--accent-ofr) !important; color: #fff !important; }
        .status-rc { background-color: var(--accent-rc) !important; color: #fff !important; }
        .timer-remaining { color: var(--accent-rc); font-family: monospace; font-size: 1rem; font-weight: bold; }

        /* Log */
        .log-entry { font-size: 0.75rem; padding: 8px; border-bottom: 1px solid var(--border-color); background: rgba(0,0,0,0.1); }
        .log-header { font-weight: 800; padding: 2px 6px; border-radius: 4px; margin-bottom: 4px; display: inline-block; font-size: 0.7rem; }
        .log-yc { background: var(--accent-yc); color: #000; }
        .log-rc { background: var(--accent-rc); color: #fff; }
        .log-ofr { background: var(--accent-ofr); color: #fff; }
        .log-default { background: var(--field-green); color: #fff; }

        /* Modal */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        #player-picker { background: var(--bg-card); width: 340px; max-height: 80%; border-radius: 12px; border: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; }
        .picker-item { padding: 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; transition: background 0.2s; }
        .picker-item:hover { background: rgba(255,255,255,0.05); }
        
        #uncontested-alert { color: var(--accent-rc); font-weight: 900; display: none; font-size: 0.8rem; background: rgba(239,68,68,0.1); padding: 2px 8px; border-radius: 4px; border: 1px solid var(--accent-rc); }
    </style>
</head>
<body id="drop-zone">

<header>
    <div class="header-top">
        <div id="team-name" style="font-weight:900; font-size: 1.1rem; letter-spacing: 0.5px; color: var(--field-green)">PRO RUGBY MANAGER</div>
        <div class="stopwatch-container">
            <div id="timer-display">00:00</div>
            <button class="sw-btn btn-start" onclick="timerStart()">START</button>
            <button class="sw-btn btn-pause" onclick="timerPause()">PAUSE</button>
            <button class="sw-btn btn-reset" onclick="timerReset()">RESET</button>
        </div>
        <div id="uncontested-alert">⚠️ UNCONTESTED SCRUM</div>
    </div>
    <div class="stats-bar">
        <span>FIELD: <b id="count-field">0</b></span>
        <span>CAT C: <b id="count-cat-c">0</b></span>
        <span>FR: <b id="count-fr">0</b></span>
        <span id="status-msg" style="margin-left:auto; font-style: italic; font-size: 0.75rem;">Drop Excel to Initialize</span>
    </div>
</header>

<main>
    <div class="col-field">
        <section class="column"><h2 style="color: var(--field-green);">Field 1-15</h2><div id="field-list" class="scroll-area"></div></section>
    </div>
    <div class="col-bench">
        <section class="column" id="bench-drop-target"><h2 style="color: var(--bench-orange);">Bench</h2><div id="bench-list" class="scroll-area"></div></section>
    </div>
    <div class="col-res-admin">
        <section class="column" id="reserve-drop-area" style="flex: 1;"><h2>Reservations</h2><div id="res-list" class="scroll-area"></div></section>
        <section class="column" style="flex: 1.5;"><h2>Trackers</h2><div id="admin-list" class="scroll-area"></div></section>
    </div>
    <div class="col-log">
        <section class="column"><h2>Activity Log</h2><div id="log-list" class="scroll-area"></div></section>
    </div>
</main>

<div id="modal-overlay">
    <div id="player-picker">
        <h2 style="font-size: 1rem; padding: 15px; margin:0; background: var(--bg-header); color:var(--field-green); text-align:center;">Select Replacement</h2>
        <div id="picker-list" style="overflow-y:auto; flex-grow:1;"></div>
        <button onclick="closePicker()" style="padding:15px; border:none; background:rgba(255,255,255,0.05); color:white; font-weight:bold; cursor:pointer;">CANCEL</button>
    </div>
</div>

<script>
    let fieldPositions = Array.from({length: 15}, (_, i) => ({ posId: i + 1, player: null }));
    let benchPlayers = [];
    let reservations = [];
    let adminCards = [];
    let logs = [];
    let draggedData = null;

    let startTime = 0, elapsedTime = 0, timerInterval = null;
    function timerStart() { if (!timerInterval) { startTime = Date.now() - elapsedTime; timerInterval = setInterval(() => { elapsedTime = Date.now() - startTime; updateTimerDisplay(); processAdminTimers(); }, 100); } }
    function timerPause() { clearInterval(timerInterval); timerInterval = null; }
    function timerReset() { if (confirm("Reset Timer?")) { timerPause(); elapsedTime = 0; updateTimerDisplay(); } }
    function updateTimerDisplay() { document.getElementById('timer-display').innerText = getFormattedTime(); }
    function getFormattedTime() { const ts = Math.floor(elapsedTime / 1000); return `${Math.floor(ts/60).toString().padStart(2,'0')}:${(ts%60).toString().padStart(2,'0')}`; }

    function processAdminTimers() {
        if (!timerInterval) return;
        adminCards.forEach(card => {
            if (card.remainingSeconds > 0) {
                const passed = Math.floor((Date.now() - card.execRealTimestamp) / 1000);
                card.remainingSeconds = Math.max(0, card.totalSeconds - passed);
            }
        });
        renderAdminCards();
    }

    function addLog(typeName, p1, p2 = null) {
        logs.unshift({ time: getFormattedTime(), typeName, p1: {...p1}, p2: p2 ? {...p2} : null });
        renderLogs();
    }

    function renderLogs() {
        document.getElementById('log-list').innerHTML = logs.map(l => {
            let logCls = 'log-default';
            if (l.typeName === 'YC') logCls = 'log-yc';
            else if (l.typeName === 'RC') logCls = 'log-rc';
            else if (l.typeName === 'OFR') logCls = 'log-ofr';
            return `<div class="log-entry"><div class="log-header ${logCls}">[${l.time}] ${l.typeName}</div><div>${l.p2 ? 'OUT:' : ''} #${l.p1.no} ${l.p1.name}</div>${l.p2 ? `<div>IN: #${l.p2.no} ${l.p2.name}</div>` : ''}</div>`;
        }).join('');
    }

    const dropZone = document.getElementById('drop-zone');
    dropZone.addEventListener('dragover', (e) => e.preventDefault());
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const workbook = XLSX.read(new Uint8Array(ev.target.result), {type: 'array'});
                processExcel(XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1}));
            };
            reader.readAsArrayBuffer(file);
        }
    });

    function processExcel(data) {
        if (data[0] && data[0][2]) document.getElementById('team-name').innerText = data[0][2];
        const players = [];
        for (let i = 2; i < data.length; i++) {
            const row = data[i]; if (!row || !row[0]) continue;
            players.push({
                id: 'P' + row[0], no: parseInt(row[0]), name: String(row[1]||"").trim(),
                category: String(row[2]||"").trim(),
                fr: { fr1: String(row[3]).toLowerCase()==='true', fr2: String(row[4]).toLowerCase()==='true', fr3: String(row[5]).toLowerCase()==='true' },
                status: 'normal'
            });
        }
        fieldPositions = players.filter(p => p.no <= 15).map((p, idx) => ({ posId: idx + 1, player: p }));
        benchPlayers = players.filter(p => p.no > 15);
        render();
    }

    function sortBench() {
        benchPlayers.sort((a, b) => {
            const aIsCard = ['yc', 'rc', 'ofr'].includes(a.status);
            const bIsCard = ['yc', 'rc', 'ofr'].includes(b.status);
            if (aIsCard && !bIsCard) return 1;
            if (!aIsCard && bIsCard) return -1;
            return a.no - b.no;
        });
    }

    function getPlayerHTML(p) {
        if (!p) return '<span style="color:var(--text-sub); font-size:0.7rem;">Empty</span>';
        let frNumbers = [];
        if (p.fr.fr1) frNumbers.push("1");
        if (p.fr.fr2) frNumbers.push("2");
        if (p.fr.fr3) frNumbers.push("3");
        const frDisplay = frNumbers.length > 0 ? `<span class="player-fr-num">${frNumbers.join(',')}</span>` : '';
        const catDisplay = p.category ? `<span class="player-cat">${p.category}</span>` : '';
        
        return `
            <span class="jersey-no">#${p.no}</span>
            <span class="player-name">${p.name}</span>
            ${catDisplay}
            ${frDisplay}
        `;
    }

    function render() {
        sortBench(); renderField(); renderBench(); renderReservations(); renderAdminCards(); updateStats();
    }

    function renderField() {
        const list = document.getElementById('field-list'); list.innerHTML = '';
        fieldPositions.forEach(item => {
            const p = item.player;
            const isReserved = p ? reservations.some(r => r.out?.id === p.id || r.in?.id === p.id) : false;
            const div = document.createElement('div');
            div.className = `player-card ${isReserved ? 'is-reserved' : ''}`;
            div.innerHTML = `<div class="pos-label">${item.posId}</div><div class="player-info">${getPlayerHTML(p)}</div>`;
            if (p) {
                div.draggable = true;
                div.ondragstart = () => { draggedData = { source: 'field', data: item }; };
            }
            div.ondragover = (e) => e.preventDefault();
            div.ondrop = (e) => {
                e.preventDefault();
                if (draggedData?.source === 'bench') {
                    const inP = draggedData.data;
                    const cardType = (['yc', 'ofr', 'rc'].includes(inP.status)) ? inP.status.toUpperCase() : null;
                    if (cardType) reservations.push({ id: Date.now(), type: 'return', cardType: cardType, posId: item.posId, in: {...inP}, out: p ? {...p} : null });
                    else if (!reservations.some(r => r.in?.id === inP.id)) reservations.push({ id: Date.now(), type: 'sub', posId: item.posId, out: p ? {...p} : null, in: {...inP} });
                    render();
                }
            };
            list.appendChild(div);
        });
    }

    function renderBench() {
        const list = document.getElementById('bench-list'); list.innerHTML = '';
        benchPlayers.forEach(p => {
            const isReserved = reservations.some(r => r.in?.id === p.id || r.out?.id === p.id);
            const statusCls = ['yc','ofr','rc','injury'].includes(p.status) ? 'status-' + p.status : '';
            const div = document.createElement('div');
            div.className = `player-card ${isReserved ? 'is-reserved' : ''} ${statusCls}`;
            let textCls = '';
            if (['medical', 'blood'].includes(p.status)) textCls = 'status-medical';
            else if (p.status === 'tactical') textCls = 'status-tactical';
            div.innerHTML = `<div class="player-info ${textCls}">${getPlayerHTML(p)}</div>`;
            if (p.status !== 'injury') {
                div.draggable = true;
                div.ondragstart = () => { draggedData = { source: 'bench', data: p }; };
            }
            div.ondragover = (e) => { e.preventDefault(); e.stopPropagation(); };
            div.ondrop = (e) => {
                e.preventDefault(); e.stopPropagation();
                if (draggedData.source === 'field') {
                    const outP = draggedData.data.player;
                    if (outP && !reservations.some(r => r.out?.id === outP.id)) {
                        reservations.push({ id: Date.now(), type: 'sub', posId: draggedData.data.posId, out: {...outP}, in: {...p} });
                        render();
                    }
                } else if (draggedData.source === 'bench') {
                    const cardStatuses = ['yc','ofr','rc'];
                    if (cardStatuses.includes(p.status) || cardStatuses.includes(draggedData.data.status)) {
                        let cardP = cardStatuses.includes(p.status) ? p : draggedData.data;
                        let normP = cardStatuses.includes(p.status) ? draggedData.data : p;
                        const adminCard = adminCards.find(a => a.out.id === cardP.id);
                        if (adminCard) {
                            reservations.push({ id: Date.now(), type: 'card_sub_waiting', bloodType: cardP.status.toUpperCase(), posId: adminCard.posId, out: {...cardP}, in: {...normP} });
                            render();
                        }
                    }
                }
            };
            list.appendChild(div);
        });
    }

    const resArea = document.getElementById('reserve-drop-area');
    resArea.ondragover = (e) => e.preventDefault();
    resArea.ondrop = (e) => {
        e.preventDefault();
        if (draggedData?.source === 'field') {
            const p = draggedData.data.player;
            if (p && !reservations.some(r => r.out?.id === p.id)) {
                reservations.push({ id: Date.now(), type: 'card', posId: draggedData.data.posId, out: {...p} });
                render();
            }
        }
    };

    function renderReservations() {
        const list = document.getElementById('res-list'); list.innerHTML = '';
        reservations.forEach(res => {
            const card = document.createElement('div'); card.className = 'res-card';
            if (res.type === 'card_sub_waiting') {
                card.innerHTML = `<button class="btn-delete" onclick="cancelRes(${res.id})">×</button><div class="res-header"><span>${res.bloodType} WAITING</span></div><div class="res-player-line"><div class="line-row"><span class="line-label">OUT</span><span class="res-no">#${res.out.no}</span><span>${res.out.name}</span></div><div class="line-row"><span class="line-label">IN</span><span class="res-no">#${res.in ? res.in.no : '--'}</span><span>${res.in ? res.in.name : 'Select...'}</span></div></div><div class="res-actions" style="grid-template-columns: 1fr 1fr;"><button style="color:var(--text-tactical)" onclick="executeCardWaitingSub(${res.id}, 'tactical')">Tactical</button><button style="color:var(--accent-rc)" onclick="executeCardWaitingSub(${res.id}, 'injury')">Injury</button></div>`;
            } else if (res.type === 'sub') {
                card.innerHTML = `<button class="btn-delete" onclick="cancelRes(${res.id})">×</button><div class="res-header">POS ${res.posId} RESERVED</div><div class="res-player-line"><div class="line-row"><span class="line-label">OUT</span><span class="res-no">#${res.out?.no||'--'}</span><span>${res.out?.name||'--'}</span></div><div class="line-row"><span class="line-label">IN</span><span class="res-no">#${res.in?.no||'--'}</span><span>${res.in?.name||'--'}</span></div></div><div class="res-actions"><button style="color:var(--text-tactical)" onclick="executeSub(${res.id}, 'tactical', 'Tactical')">Tactical</button><button style="color:var(--accent-rc)" onclick="executeSub(${res.id}, 'injury', 'Injury')">Injury</button><button onclick="moveToAdminBlood(${res.id}, 'Blood')">Blood</button><button onclick="moveToAdminBlood(${res.id}, 'HIA')">HIA</button><button onclick="moveToAdminBlood(${res.id}, 'Blood/HIA')">B/HIA</button><button onclick="executeSub(${res.id}, 'normal', 'Temp')">Temp</button></div>`;
            } else if (res.type === 'blood_return') {
                card.innerHTML = `<button class="btn-delete" onclick="cancelRes(${res.id})">×</button><div class="res-header"><span>${res.bloodType} RETURN</span><span style="color:var(--field-green)">READY</span></div><div class="res-player-line"><div class="line-row"><span class="line-label">REJOIN</span><span class="res-no">#${res.out.no}</span><span>${res.out.name}</span></div><div class="line-row"><span class="line-label">TYPE</span><span>${res.subType}</span></div></div><button class="btn-execute-large" onclick="executeBloodReturn(${res.id})">EXECUTE RETURN</button>`;
            } else if (res.type === 'return') {
                card.innerHTML = `<button class="btn-delete" onclick="cancelRes(${res.id})">×</button><div class="res-header">POS ${res.posId} ${res.cardType} OVER</div><div class="res-player-line"><div class="line-row"><span class="line-label">IN</span><span class="res-no">#${res.in.no}</span><span>${res.in.name}</span></div></div><button class="btn-execute-large" onclick="executeReturn(${res.id})">RE-ENTER FIELD</button>`;
            } else {
                card.innerHTML = `<button class="btn-delete" onclick="cancelRes(${res.id})">×</button><div class="res-header">POS ${res.posId} DISCIPLINE</div><div class="res-player-line"><div class="line-row"><span class="line-label">OUT</span><span class="res-no">#${res.out.no}</span><span>${res.out.name}</span></div></div><div class="res-actions"><button style="background:var(--accent-yc);color:black" onclick="moveToAdminCard(${res.id}, 'YC')">YC</button><button style="background:var(--accent-rc);color:white" onclick="moveToAdminCard(${res.id}, 'RC')">RC</button><button style="background:var(--accent-ofr);color:white" onclick="moveToAdminCard(${res.id}, 'OFR')">OFR</button></div>`;
            }
            list.appendChild(card);
        });
    }

    function executeSub(resId, type, typeName) {
        const res = reservations.find(r => r.id === resId);
        if (!res.in) {
            const list = document.getElementById('picker-list'); list.innerHTML = '';
            benchPlayers.filter(p => !['yc','ofr','rc'].includes(p.status)).forEach(p => {
                const item = document.createElement('div'); item.className = 'picker-item';
                item.innerHTML = `<span>#${p.no} ${p.name}</span><span>${p.category}</span>`;
                item.onclick = () => { res.in = {...p}; closePicker(); executeSub(resId, type, typeName); };
                list.appendChild(item);
            });
            document.getElementById('modal-overlay').style.display = 'flex'; return;
        }
        const fPos = fieldPositions.find(p => p.posId === res.posId);
        const inIdx = benchPlayers.findIndex(p => p.id === res.in.id);
        if (inIdx !== -1) {
            if (res.out) benchPlayers[inIdx] = {...res.out, status: type};
            else benchPlayers.splice(inIdx, 1);
        }
        fPos.player = {...res.in, status: 'normal'};
        addLog(typeName, res.out || res.in, res.out ? res.in : null);
        reservations = reservations.filter(r => r.id !== resId);
        render();
    }

    function executeCardWaitingSub(resId, type) {
        const res = reservations.find(r => r.id === resId);
        if (!res.in) {
            const list = document.getElementById('picker-list'); list.innerHTML = '';
            benchPlayers.filter(p => !['yc','ofr','rc'].includes(p.status)).forEach(p => {
                const item = document.createElement('div'); item.className = 'picker-item';
                item.innerHTML = `<span>#${p.no} ${p.name}</span>`;
                item.onclick = () => { res.in = {...p}; closePicker(); executeCardWaitingSub(resId, type); };
                list.appendChild(item);
            });
            document.getElementById('modal-overlay').style.display = 'flex'; return;
        }
        const fPos = fieldPositions.find(p => p.posId === res.posId);
        benchPlayers = benchPlayers.filter(p => !(p.id === res.out.id && ['yc','rc','ofr'].includes(p.status)));
        const inIdx = benchPlayers.findIndex(p => p.id === res.in.id);
        if (inIdx !== -1) { benchPlayers[inIdx] = {...res.out, status: type}; }
        fPos.player = {...res.in, status: 'normal'};
        adminCards = adminCards.filter(a => a.out.id !== res.out.id);
        addLog(`Off-field Sub (${type})`, res.out, res.in);
        reservations = reservations.filter(r => r.id !== resId);
        render();
    }

    function moveToAdminBlood(resId, typeName) {
        const res = reservations.find(r => r.id === resId);
        const fPos = fieldPositions.find(p => p.posId === res.posId);
        const now = new Date();
        adminCards.push({
            id: Date.now(), type: 'BLOOD', bloodType: typeName, gameTime: getFormattedTime(),
            pcTime: `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`,
            out: {...res.out}, in: {...res.in}, posId: res.posId,
            totalSeconds: 900, remainingSeconds: 900, execRealTimestamp: Date.now()
        });
        const bIdx = benchPlayers.findIndex(p => p.id === res.in.id);
        if(bIdx !== -1) benchPlayers[bIdx] = {...res.out, status: 'blood'};
        fPos.player = {...res.in, status: 'normal'};
        addLog(typeName, res.out, res.in);
        reservations = reservations.filter(r => r.id !== resId);
        render();
    }

    function executeBloodReturn(resId) {
        const res = reservations.find(r => r.id === resId);
        const fPos = fieldPositions.find(p => p.posId === res.posId);
        const currentIn = fPos.player;
        const bIdx = benchPlayers.findIndex(p => p.id === res.out.id);
        if (res.subType === '復帰') {
            fPos.player = {...res.out, status: 'normal'};
            if (bIdx !== -1) benchPlayers[bIdx] = {...currentIn, status: 'normal'};
        } else {
            if (bIdx !== -1) benchPlayers[bIdx].status = (res.subType === '戦術' ? 'tactical' : 'injury');
        }
        addLog(`Blood Return (${res.subType})`, res.out, res.in);
        reservations = reservations.filter(r => r.id !== resId);
        render();
    }

    function moveToAdminCard(resId, cardType) {
        const res = reservations.find(r => r.id === resId);
        const now = new Date();
        adminCards.push({
            id: Date.now(), type: cardType, gameTime: getFormattedTime(), pcTime: `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`,
            out: {...res.out}, posId: res.posId, totalSeconds: cardType === 'YC' ? 600 : (cardType === 'RC' ? 1200 : 0), remainingSeconds: cardType === 'YC' ? 600 : (cardType === 'RC' ? 1200 : 0), execRealTimestamp: Date.now()
        });
        benchPlayers.push({...res.out, status: cardType.toLowerCase()});
        fieldPositions.find(p => p.posId === res.posId).player = null;
        addLog(cardType, res.out);
        reservations = reservations.filter(r => r.id !== resId);
        render();
    }

    function executeReturn(resId) {
        const res = reservations.find(r => r.id === resId);
        benchPlayers = benchPlayers.filter(p => !(p.id === res.in.id && ['yc','rc','ofr'].includes(p.status)));
        fieldPositions.find(p => p.posId === res.posId).player = {...res.in, status: 'normal'};
        addLog(`${res.cardType} Return`, res.in);
        reservations = reservations.filter(r => r.id !== resId);
        render();
    }

    function renderAdminCards() {
        const list = document.getElementById('admin-list'); list.innerHTML = '';
        adminCards.forEach(card => {
            const div = document.createElement('div'); div.className = 'admin-card';
            const m = Math.floor(card.remainingSeconds / 60), s = card.remainingSeconds % 60;
            if (card.type === 'BLOOD') {
                div.innerHTML = `<button class="btn-delete" onclick="adminDelete(${card.id})">×</button><div class="res-header"><span>${card.bloodType}</span><span class="timer-remaining">${m}:${s.toString().padStart(2,'0')}</span></div><div class="res-player-line" style="font-size:0.8rem">OUT: #${card.out.no} / IN: #${card.in.no}</div><div class="res-actions"><button onclick="bloodToReserve(${card.id}, '復帰')">Rejoin</button><button onclick="bloodToReserve(${card.id}, '戦術')">Tactical</button><button onclick="bloodToReserve(${card.id}, '負傷')">Injury</button></div>`;
            } else {
                div.innerHTML = `<button class="btn-delete" onclick="adminDelete(${card.id})">×</button><div class="res-header"><span>${card.type} TRACKER</span><span class="timer-remaining">${m}:${s.toString().padStart(2,'0')}</span></div><div class="res-player-line" style="font-size:0.8rem">PLAYER: #${card.out.no} ${card.out.name}</div><div class="res-actions" style="grid-template-columns: 1fr 1fr;"><button onclick="adminAction(${card.id}, 'return')">Return</button><button onclick="adminAction(${card.id}, 'tactical')">Replace</button></div>`;
            }
            list.appendChild(div);
        });
    }

    function adminAction(adminId, actionType) {
        const card = adminCards.find(a => a.id === adminId);
        if (actionType === 'return') reservations.push({ id: Date.now(), type: 'return', cardType: card.type, posId: card.posId, in: card.out });
        else reservations.push({ id: Date.now(), type: 'card_sub_waiting', bloodType: card.type, posId: card.posId, out: card.out, in: null });
        adminCards = adminCards.filter(a => a.id !== adminId);
        render();
    }

    function bloodToReserve(adminId, subType) {
        const card = adminCards.find(a => a.id === adminId);
        reservations.push({ id: Date.now(), type: 'blood_return', posId: card.posId, bloodType: card.bloodType, subType: subType, out: card.out, in: card.in });
        adminCards = adminCards.filter(a => a.id !== adminId);
        render();
    }

    function cancelRes(id) { reservations = reservations.filter(r => r.id !== id); render(); }
    function adminDelete(id) { if(confirm("Delete Tracker?")) { adminCards = adminCards.filter(a => a.id !== id); render(); } }
    function closePicker() { document.getElementById('modal-overlay').style.display = 'none'; }
    function updateStats() {
        const onField = fieldPositions.map(p => p.player).filter(p => p);
        document.getElementById('count-field').innerText = onField.length;
        document.getElementById('count-cat-c').innerText = onField.filter(p => p.category.includes('C')).length;
        document.getElementById('count-fr').innerText = onField.filter(p => p.fr.fr1 || p.fr.fr2 || p.fr.fr3).length;
        const p1 = fieldPositions.find(p => p.posId === 1)?.player, p2 = fieldPositions.find(p => p.posId === 2)?.player, p3 = fieldPositions.find(p => p.posId === 3)?.player;
        document.getElementById('uncontested-alert').style.display = (p1?.fr.fr1 && p2?.fr.fr2 && p3?.fr.fr3) ? 'none' : 'block';
    }
</script>
</body>
</html>
