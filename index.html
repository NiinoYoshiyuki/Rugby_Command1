<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Rugby Command Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-dark: #1e2a38;
            --header-bg: #1a252f;
            --accent-yellow: #f1c40f;
            --btn-green: #2ecc71;
            --btn-blue: #3498db;
            --btn-red: #e74c3c;
            --btn-orange: #e67e22;
            --btn-gray: #95a5a6;
            --circle-green: #2ecc71;
            --circle-blue: #3498db;
            --circle-red: #ff0000;
            --selected-orange: #f39c12;
            --tactical-blue: #2980b9; 
            --injured-gray: #bdc3c7;
            --light-red: #ffcdd2;
            --fr-highlight: #e3f2fd;
            --treating-red: #ff0000; 
        }

        body {
            margin: 0; font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            background-color: var(--bg-dark); color: #ffffff;
            overflow: hidden; display: flex; flex-direction: column; height: 100vh;
            touch-action: none; /* 全体のスクロールを抑止しドラッグを安定させる */
        }

        header {
            background-color: var(--header-bg); padding: 8px 15px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 2px solid #333; height: 65px; box-sizing: border-box;
            position: relative;
        }

        #uncontested-banner {
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: #ff0000;
            color: white;
            text-align: center;
            font-weight: bold;
            padding: 5px 15px;
            font-size: 14px;
            border-radius: 4px;
            white-space: nowrap;
            z-index: 10;
        }

        .header-left { display: flex; align-items: center; gap: 20px; }
        #team-name-display { font-size: 22px; font-weight: 900; color: var(--accent-yellow); border-left: 5px solid var(--accent-yellow); padding-left: 15px; }
        #category-display { font-size: 18px; font-weight: bold; color: white; background: rgba(255,255,255,0.1); padding: 4px 12px; border-radius: 4px; }

        .timer-container { position: relative; display: flex; align-items: center; gap: 10px; background: #000; padding: 5px 15px; border-radius: 10px; border: 2px solid #444; }
        #timer-display { font-family: 'Courier New', Courier, monospace; font-size: 42px; color: #00ff00; font-weight: bold; min-width: 130px; text-align: center; cursor: pointer; user-select: none; }
        #start-btn { min-width: 80px; font-weight: 900; border-radius: 5px; border: none; padding: 10px; cursor: pointer; }
        .btn-start-style { background-color: var(--btn-green); color: white; }
        .btn-stop-style { background-color: var(--btn-red); color: white; }

        #timer-edit-popup { display: none; position: absolute; top: 60px; left: 0; background: #333; border: 2px solid var(--accent-yellow); padding: 10px; border-radius: 8px; z-index: 4000; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .edit-row { display: flex; align-items: center; justify-content: center; gap: 15px; }
        .edit-unit { display: flex; flex-direction: column; align-items: center; }
        .spin-btn { background: #555; color: white; border: none; width: 50px; height: 40px; font-size: 24px; cursor: pointer; border-radius: 4px; }
        .spin-btn:hover { background: #777; }
        .edit-val { font-size: 32px; font-weight: bold; margin: 5px 0; color: var(--accent-yellow); font-family: monospace; }

        main { 
            display: grid; 
            grid-template-columns: 310px 310px 310px 1fr; 
            gap: 10px; padding: 10px; flex-grow: 1; height: calc(100vh - 65px); box-sizing: border-box; 
        }

        .column { display: flex; flex-direction: column; gap: 10px; height: 100%; overflow: hidden; }

        .panel-header { padding: 6px; text-align: center; font-weight: bold; font-size: 13px; color: white; height: 30px; box-sizing: border-box; }
        .panel-header.green { background-color: var(--btn-green); }
        .panel-header.blue { background-color: var(--btn-blue); }
        .panel-header.yellow { background-color: var(--accent-yellow); color: black; }

        .list-container { background: white; color: black; border: 1px solid #ccc; overflow: hidden; box-sizing: border-box; transition: background-color 0.2s; }
        .list-container.drag-over { background-color: #e3f2fd; border: 2px dashed var(--btn-blue); }
        
        #field-list { height: 550px; }
        #bench-list { height: 295px; }
        #reservation-list, #management-list, #main-log, #penalty-log, #ejected-list { overflow-y: auto; }

        #setting-area { padding: 8px; display: flex; flex-direction: column; gap: 8px; }
        .setting-row { display: flex; gap: 5px; width: 100%; align-items: center; }
        .setting-btn { flex: 1; padding: 8px 2px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; color: white; font-size: 11px; text-align: center; }
        
        .half-end-box { flex: 1.5; display: flex; align-items: center; background: #eee; border-radius: 4px; padding-right: 5px; }
        #half-end-time-display { font-weight: bold; font-size: 14px; color: var(--btn-red); margin-left: auto; }

        .player-row { display: grid; grid-template-columns: 28px 42px 135px 30px 45px 35px; align-items: center; height: 34.5px; border-bottom: 1px solid #eee; padding: 0 2px 0 5px; font-size: 13px; cursor: pointer; background-color: white; position: relative; color: #000; }
        
        .player-row.selected { background-color: var(--selected-orange) !important; color: white !important; }
        .player-row.selected * { color: white !important; }
        .player-row.fr-match { background-color: var(--fr-highlight); }
        
        .player-row.status-treating { color: var(--treating-red) !important; }
        .player-row.status-treating .player-name { color: var(--treating-red) !important; }
        
        .player-row.status-tactical-out { color: var(--tactical-blue) !important; }
        .player-row.status-tactical-out .player-name { color: var(--tactical-blue) !important; }
        
        .player-row.status-injured-out { background-color: var(--injured-gray) !important; color: #7f8c8d !important; cursor: not-allowed; }
        .player-row.status-injured-out * { color: #7f8c8d !important; }
        
        .player-row.empty-row { color: #888; } 

        .pos-circle { width: 20px; height: 20px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; }
        .field-circle { background-color: var(--circle-green); }
        .bench-circle { background-color: var(--circle-blue); }
        .red-circle { background-color: var(--circle-red); }
        .player-name { font-weight: 900; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .fr-cond { color: var(--btn-orange); font-weight: bold; font-size: 11px; text-align: right; }

        .btn-ejected-del { background: var(--btn-gray); color: white; border: none; padding: 2px 4px; border-radius: 3px; font-size: 9px; cursor: pointer; font-weight: bold; }

        .log-entry { font-size: 12px; padding: 8px; border-bottom: 1px solid #ddd; position: relative; color: black; }
        .log-entry.yc-bg { background-color: #fff176; }
        .log-entry.rc-bg { background-color: #ffcdd2; }
        .btn-log-del { position: absolute; top: 5px; right: 5px; background: var(--btn-gray); color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; }

        .reserve-card { margin: 5px; padding: 8px; border: 2px solid var(--btn-green); border-radius: 8px; background: white; position: relative; display: flex; align-items: center; font-size: 12px; gap: 5px; }
        .reserve-info { flex-grow: 1; overflow: hidden; }
        .reserve-remaining { position: absolute; top: 5px; right: 8px; color: var(--btn-red); font-weight: bold; font-size: 12px; font-family: monospace; }
        .reserve-btns { display: flex; gap: 3px; flex-shrink: 0; margin-top: 15px; }
        .btn-reserve-exe { background: var(--btn-green); color: white; border: none; width: 45px; height: 35px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; }
        .btn-reserve-del { background: var(--btn-gray); color: white; border: none; width: 45px; height: 35px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; }

        .mgt-card { margin: 5px; padding: 10px; border: 2px solid var(--btn-orange); border-radius: 10px; background: white; }
        .mgt-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 8px; font-size: 11px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .mgt-type { color: var(--btn-orange); }
        .mgt-timer { font-size: 24px; color: var(--btn-red); font-family: monospace; font-weight: bold; }
        .mgt-player-info { font-size: 13px; margin: 8px 0; line-height: 1.4; }
        .mgt-reason-input { width: 100%; padding: 5px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 12px; }
        .mgt-btns-row { display: flex; flex-direction: column; gap: 8px; }
        .mgt-status-btns { display: flex; gap: 4px; justify-content: flex-start; flex-wrap: wrap; align-items: center; }
        .mgt-status-btns button { font-size: 11px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; background: #f8f8f8; font-weight: bold; flex: 1; min-width: 60px; }
        
        .mgt-status-btns button.active-yellow { background: var(--accent-yellow) !important; color: black !important; border-color: var(--accent-yellow) !important; }
        .mgt-status-btns button.active-red { background: var(--light-red) !important; color: #c0392b !important; border-color: var(--btn-red) !important; }
        .mgt-status-btns button.active-normal { background: var(--btn-orange) !important; color: white !important; border-color: var(--btn-orange) !important; }
        .btn-decision-exe { background: var(--btn-green) !important; color: white !important; border-color: var(--btn-green) !important; }

        .mgt-action-btns { display: flex; gap: 4px; justify-content: flex-end; }
        .btn-mgt-exe { background: var(--btn-green); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; }
        .btn-mgt-del { background: var(--btn-gray); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 15px; border-radius: 12px; width: 310px; color: black; max-height: 90vh; overflow-y: auto; }
        .modal-title { font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid var(--btn-blue); padding-bottom: 5px; font-size: 14px; }

        #floating-menu { display: none; position: fixed; top: 120px; left: 50%; transform: translateX(-50%); width: 280px; background: var(--bg-dark); border-radius: 12px; border: 2px solid #444; z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); touch-action: none; }
        #menu-drag-handle { padding: 10px; background: #1a252f; cursor: move; text-align: center; color: var(--accent-yellow); font-weight: bold; border-radius: 10px 10px 0 0; user-select: none; }
        .menu-grid { padding: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .menu-grid button { padding: 10px 5px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; font-size: 12px; }
        #open-menu-btn { position: fixed; bottom: 20px; right: 20px; padding: 15px 35px; background: var(--accent-yellow); color: black; font-weight: 900; border-radius: 40px; border: none; cursor: pointer; z-index: 1000; }
    </style>
</head>
<body onload="init()">

<header>
    <div class="header-left">
        <div id="team-name-display">TEAM NAME</div>
        <div id="category-display">Category: 0/0</div>
    </div>
    <div id="uncontested-banner">アンコンテスト・スクラム</div>
    <div class="header-right" style="display:flex; align-items:center; gap:15px;">
        <div class="timer-container">
            <div id="timer-display" ondblclick="toggleTimerEdit()">00:00</div>
            <button onclick="toggleTimer()" id="start-btn" class="btn-start-style">START</button>
            <div id="timer-edit-popup">
                <div class="edit-row">
                    <div class="edit-unit">
                        <button class="spin-btn" onclick="adjustTime(60)">▲</button>
                        <div class="edit-val" id="edit-min">00</div>
                        <button class="spin-btn" onclick="adjustTime(-60)">▼</button>
                    </div>
                    <div style="font-size:32px; font-weight:bold; padding-top:40px;">:</div>
                    <div class="edit-unit">
                        <button class="spin-btn" onclick="adjustTime(1)">▲</button>
                        <div class="edit-val" id="edit-sec">00</div>
                        <button class="spin-btn" onclick="adjustTime(-1)">▼</button>
                    </div>
                </div>
                <button onclick="toggleTimerEdit()" style="width:100%; margin-top:10px; padding:5px; background:var(--btn-gray); color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">閉じる</button>
            </div>
        </div>
        <button onclick="resetTimer()" style="background:var(--btn-gray); color:white; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; font-weight:bold;">RESET</button>
    </div>
</header>

<main>
    <div class="column">
        <div class="panel-header green">FIELD (1-15)</div>
        <div class="list-container" id="field-list"></div>
        <div class="panel-header yellow">SETTING</div>
        <div class="list-container" id="setting-area" style="flex-grow:1;">
            <div class="setting-row">
                <input type="file" id="excel-input" style="display:none" onchange="handleExcel(event)">
                <button class="setting-btn" onclick="document.getElementById('excel-input').click()" style="background:var(--btn-blue);">LOAD EXCEL</button>
                <button class="setting-btn" onclick="openCatModal()" style="background:var(--btn-blue);">CATEGORY</button>
            </div>
            <div class="setting-row">
                <button class="setting-btn" onclick="openRestoreModal()" style="background:var(--btn-red);">選手復帰</button>
                <div class="half-end-box">
                    <button class="setting-btn" onclick="recordHalfEnd()" style="background:var(--btn-orange); flex:none; width:65px;">前半終了</button>
                    <div id="half-end-time-display">--:--</div>
                </div>
            </div>
        </div>
    </div>
    <div class="column">
        <div class="panel-header blue">BENCH (16-23)</div>
        <div class="list-container" id="bench-list"></div>
        <div class="panel-header yellow">退場</div>
        <div class="list-container" id="ejected-list" style="height: 140px;"></div>
        <div class="panel-header yellow">PENALTY LOG</div>
        <div class="list-container" id="penalty-log" style="flex-grow: 1;"></div>
    </div>
    <div class="column">
        <div class="panel-header yellow">予約リスト</div>
        <div class="list-container" id="reservation-list" style="height: 50%;"></div>
        <div class="panel-header yellow">管理エリア</div>
        <div class="list-container" id="management-list" style="flex-grow: 1;"></div>
    </div>
    <div class="column">
        <div class="panel-header yellow">LOG</div>
        <div class="list-container" id="main-log" style="flex-grow: 1;"></div>
    </div>
</main>

<div id="player-select-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">交代選手を選択してください</div>
        <div id="modal-player-list"></div>
        <button onclick="closeModal()" style="width:100%; margin-top:10px; padding:10px; background:var(--btn-gray); color:white; border:none; border-radius:4px; font-weight:bold;">キャンセル</button>
    </div>
</div>

<div id="restore-player-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">選手強制復帰（初期状態）</div>
        <div id="restore-player-list" style="max-height: 400px; overflow-y: auto;"></div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button id="restore-execute-btn" onclick="executePlayerRestore()" style="flex:1; padding:10px; background:var(--btn-red); color:white; border:none; border-radius:4px; font-weight:bold; opacity:0.5;" disabled>初期位置に戻す</button>
            <button onclick="closeRestoreModal()" style="flex:1; padding:10px; background:var(--btn-gray); color:white; border:none; border-radius:4px; font-weight:bold;">閉じる</button>
        </div>
    </div>
</div>

<div id="cat-setting-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">CATEGORY上限設定 (A2+B+C)</div>
        <div style="margin: 20px 0; display: flex; flex-direction: column; align-items: center; gap: 10px;">
            <label style="font-size:12px; color:#666;">合計人数上限</label>
            <div style="display: flex; align-items: center; gap: 20px;">
                <button class="spin-btn" onclick="adjustCatLimit(-1)" style="background:#555; color:white; border:none; width:50px; height:50px; font-size:24px; border-radius:4px; cursor:pointer;">▼</button>
                <div id="cat-limit-display" style="font-size: 36px; font-weight: bold; color: var(--btn-blue); min-width: 50px; text-align: center;">4</div>
                <button class="spin-btn" onclick="adjustCatLimit(1)" style="background:#555; color:white; border:none; width:50px; height:50px; font-size:24px; border-radius:4px; cursor:pointer;">▲</button>
            </div>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="saveCatLimit()" style="flex:1; padding:10px; background:var(--btn-blue); color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">保存</button>
            <button onclick="closeCatModal()" style="flex:1; padding:10px; background:var(--btn-gray); color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">閉じる</button>
        </div>
    </div>
</div>

<div id="floating-menu">
    <div id="menu-drag-handle">COMMAND CENTER</div>
    <div class="menu-grid">
        <button style="background:var(--btn-blue)" onclick="menuAction('戦術交代')">戦術交代</button>
        <button style="background:var(--accent-yellow); color:black" onclick="menuAction('YC')">YC</button>
        <button style="background:#2980b9" onclick="menuAction('負傷交代')">負傷交代</button>
        <button style="background:var(--btn-red)" onclick="menuAction('RC')">RC</button>
        <button style="background:#3498db" onclick="menuAction('出血交代')">出血交代</button>
        <button style="background:#8e44ad" onclick="menuAction('OFR')">OFR</button>
        <button style="background:#2c3e50" onclick="menuAction('HIA')">HIA</button>
        <button style="background:#1abc9c" onclick="menuAction('一時退出')">一時退出</button>
        <button style="background:#5D4037" onclick="menuAction('出血HIA')">出血HIA</button>
        <button style="background:#795548" onclick="menuAction('SWAP')">SWAP</button>
        <button style="background:#555; grid-column: span 2;" onclick="closeMenu()">CLOSE</button>
    </div>
</div>

<button id="open-menu-btn" onclick="openMenu()">COMMAND MENU</button>

<script>
    // 基本変数と初期化
    let seconds = 0, timerInterval = null, selectedIds = [], playersMaster = [], initialMaster = [], managementTimers = {}, ejectedPlayers = [], managementSeconds = {};
    let isUncontested = false, categoryLimit = 4, halfEndTime = null, restoreTargetId = null;

    function init() {
        openMenu();
        setupDragAndDrop();
        setupFloatingMenuDraggable();
        renderLists();
    }

    // ドラッグ＆ドロップ (Excel読み込み)
    function setupDragAndDrop() {
        const dropZones = [document.getElementById('field-list'), document.getElementById('bench-list')];
        dropZones.forEach(zone => {
            zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
            zone.addEventListener('dragleave', () => { zone.classList.remove('drag-over'); });
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) { processExcelFile(file); }
            });
        });
    }

    // フローティングメニューのドラッグ設定 (マウス & タッチ対応)
    function setupFloatingMenuDraggable() {
        const menu = document.getElementById("floating-menu");
        const handle = document.getElementById("menu-drag-handle");
        let active = false;
        let currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;

        // マウス操作
        handle.addEventListener("mousedown", dragStart);
        document.addEventListener("mousemove", drag);
        document.addEventListener("mouseup", dragEnd);

        // タッチ操作
        handle.addEventListener("touchstart", dragStart, {passive: false});
        document.addEventListener("touchmove", drag, {passive: false});
        document.addEventListener("touchend", dragEnd);

        function dragStart(e) {
            if (e.type === "touchstart") {
                initialX = e.touches[0].clientX - xOffset;
                initialY = e.touches[0].clientY - yOffset;
            } else {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
            }
            if (e.target === handle) {
                active = true;
                // タッチ時のスクロール防止
                if(e.type === "touchstart") e.preventDefault();
            }
        }

        function drag(e) {
            if (active) {
                e.preventDefault();
                if (e.type === "touchmove") {
                    currentX = e.touches[0].clientX - initialX;
                    currentY = e.touches[0].clientY - initialY;
                } else {
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                }
                xOffset = currentX;
                yOffset = currentY;
                setTranslate(currentX, currentY, menu);
            }
        }

        function setTranslate(xPos, yPos, el) {
            // translateだと初期配置との兼ね合いが難しいため、left/topで制御
            // 初期状態が left:50%, translateX:-50% なので、そのオフセットを考慮
            el.style.transform = `translate(calc(-50% + ${xPos}px), ${yPos}px)`;
        }

        function dragEnd() {
            initialX = currentX;
            initialY = currentY;
            active = false;
        }
    }

    function openMenu() { document.getElementById('floating-menu').style.display = 'block'; }
    function closeMenu() { document.getElementById('floating-menu').style.display = 'none'; }

    // 以下、ロジック部分は前回の指示（色ルール等）を完全維持
    function openCatModal() { 
        document.getElementById('cat-limit-display').innerText = categoryLimit; 
        document.getElementById('cat-setting-modal').style.display = 'flex'; 
    }
    function closeCatModal() { document.getElementById('cat-setting-modal').style.display = 'none'; }
    function adjustCatLimit(val) {
        let display = document.getElementById('cat-limit-display');
        let current = parseInt(display.innerText) || 0;
        display.innerText = Math.max(0, current + val);
    }
    function saveCatLimit() { 
        categoryLimit = parseInt(document.getElementById('cat-limit-display').innerText) || 0; 
        closeCatModal(); 
        updateCategoryDisplay(); 
    }

    function openRestoreModal() {
        if (initialMaster.length === 0) return alert("Excelデータが読み込まれていません。");
        const list = document.getElementById('restore-player-list');
        list.innerHTML = '';
        restoreTargetId = null;
        document.getElementById('restore-execute-btn').disabled = true;
        document.getElementById('restore-execute-btn').style.opacity = "0.5";

        initialMaster.forEach((p, idx) => {
            if (p.id === 'empty') return;
            const div = document.createElement('div');
            div.className = 'player-row';
            div.style.border = "1px solid #eee";
            div.style.marginBottom = "2px";
            div.dataset.rid = p.id;
            const posNum = idx + 1;
            const typeClass = posNum <= 15 ? 'field-circle' : 'bench-circle';
            div.innerHTML = `<div class="pos-circle ${typeClass}">${posNum}</div><div class="jersey-no">No.${p.no}</div><div class="player-name">${p.name}</div><div style="font-size:10px; opacity:0.6; text-align:center;">${p.cat}</div><div class="fr-cond">${p.fr}</div><div></div>`;
            div.onclick = () => {
                document.querySelectorAll('#restore-player-list .player-row').forEach(r => r.classList.remove('selected'));
                div.classList.add('selected');
                restoreTargetId = p.id;
                document.getElementById('restore-execute-btn').disabled = false;
                document.getElementById('restore-execute-btn').style.opacity = "1";
            };
            list.appendChild(div);
        });
        document.getElementById('restore-player-modal').style.display = 'flex';
    }

    function closeRestoreModal() { document.getElementById('restore-player-modal').style.display = 'none'; }

    function executePlayerRestore() {
        if (!restoreTargetId) return;
        const pInitial = initialMaster.find(x => x.id === restoreTargetId);
        const originalIdx = initialMaster.findIndex(x => x.id === restoreTargetId);
        if (!pInitial || originalIdx === -1) return;

        if (!confirm(`No.${pInitial.no} ${pInitial.name} を初期位置に強制復帰させますか？`)) return;

        playersMaster = playersMaster.map(p => p.id === restoreTargetId ? { id: 'empty', no: '', name: '-----', cat: '', fr: '', status: 'normal' } : p);
        ejectedPlayers = ejectedPlayers.filter(p => p.id !== restoreTargetId);

        document.querySelectorAll('.reserve-card, .mgt-card').forEach(card => {
            if (card.dataset.outId === restoreTargetId || card.dataset.inId === restoreTargetId) {
                const id = card.id.split('-')[1];
                if (managementTimers[id]) clearInterval(managementTimers[id]);
                delete managementTimers[id]; delete managementSeconds[id];
                card.remove();
            }
        });

        playersMaster[originalIdx] = JSON.parse(JSON.stringify(pInitial));
        playersMaster[originalIdx].status = 'normal';

        addLog("選手強制復帰", null, pInitial, `ポジション ${originalIdx + 1} へ復帰`);
        renderLists();
        checkFRConditions();
        closeRestoreModal();
    }

    function updateCategoryDisplay() {
        let count = 0;
        for (let i = 0; i < 15; i++) {
            const cat = (playersMaster[i].cat || '').toUpperCase();
            if (['A2','B','C','Ａ２','Ｂ','Ｃ'].includes(cat)) count++;
        }
        document.getElementById('category-display').innerText = `Category: ${count}/${categoryLimit}`;
    }

    function selectPlayer(rowElement) {
        const id = rowElement.dataset.id;
        if (!id) return;
        const p = playersMaster.find(x => x.id === id) || ejectedPlayers.find(x => x.id === id);
        if (p?.status === 'injured-out') return;

        const idx = selectedIds.indexOf(id);
        if (idx > -1) {
            rowElement.classList.remove('selected');
            selectedIds.splice(idx, 1);
        } else {
            rowElement.classList.add('selected');
            selectedIds.push(id);
        }
        updateFRHighlight();
    }

    function updateFRHighlight() {
        document.querySelectorAll('.player-row').forEach(r => r.classList.remove('fr-match'));
        if (selectedIds.length === 0) return;
        const lastSelectedId = selectedIds[selectedIds.length - 1];
        let lastIdx = playersMaster.findIndex(p => p.id === lastSelectedId);
        let pos = -1;
        if (lastIdx !== -1 && lastIdx < 15) pos = lastIdx + 1;
        else { const ejectedP = ejectedPlayers.find(p => p.id === lastSelectedId); if (ejectedP) pos = ejectedP.originalPos; }
        if (pos === -1 || pos > 15) return;
        let targetFR = (pos >= 1 && pos <= 3) ? pos.toString() : (pos >= 4 && pos <= 8 ? "FR" : "");
        if (pos <= 3) {
            document.querySelectorAll('.player-row').forEach(row => {
                const pid = row.dataset.id;
                const p = playersMaster.find(x => x.id === pid) || ejectedPlayers.find(x => x.id === pid);
                if (p && p.status !== 'injured-out' && p.fr.includes(targetFR)) row.classList.add('fr-match');
            });
        }
    }

    function clearSelection() { 
        document.querySelectorAll('.player-row').forEach(r => { r.classList.remove('selected'); r.classList.remove('fr-match'); });
        selectedIds = []; 
    }

    function validateCatLimit(outId, inId, type) {
        if (['YC', 'RC', 'OFR'].includes(type)) return true;
        let tempPlayers = [...playersMaster];
        let outIdx = tempPlayers.findIndex(p => p.id === outId);
        if (outIdx === -1) { const ejectedP = ejectedPlayers.find(p => p.id === outId); if (ejectedP) outIdx = ejectedP.originalPos - 1; }
        let inIdx = tempPlayers.findIndex(p => p.id === inId);
        if (outIdx !== -1 && outIdx < 15 && inIdx !== -1) tempPlayers[outIdx] = tempPlayers[inIdx];
        else if (outIdx !== -1 && outIdx < 15) tempPlayers[outIdx] = { cat: '' };
        let count = 0;
        for (let i = 0; i < 15; i++) {
            const cat = (tempPlayers[i].cat || '').toUpperCase();
            if (['A2','B','C','Ａ２','Ｂ','Ｃ'].includes(cat)) count++;
        }
        if (count > categoryLimit) return confirm(`！！！カテゴリー人数オーバー！！！\n(現在:${count}/制限:${categoryLimit})\n続行しますか？`);
        return true;
    }

    function recordHalfEnd() {
        if (halfEndTime !== null && !confirm("再計算しますか？")) return;
        halfEndTime = seconds;
        const currentTimeStr = formatTimerStr(seconds);
        document.getElementById('half-end-time-display').innerText = currentTimeStr;
        addLog("前半終了", null, null, `記録時間: ${currentTimeStr}`);
        document.querySelectorAll('.mgt-card').forEach(card => {
            const mid = card.id.replace('mgt-', ''), type = card.dataset.originType;
            if (['YC', 'RC', 'OFR', 'HIA', '出血HIA', '出血交代', '一時退出'].includes(type)) {
                const startSec = timeStrToSeconds(card.dataset.startTimeStr || "00:00");
                const elapsedSec = seconds - startSec;
                let initialDuration = (type === 'YC' || type === 'OFR') ? 600 : (type === 'RC' ? 1200 : (type === 'HIA' ? 720 : (type === '出血HIA' ? 1020 : 900)));
                managementSeconds[mid] = Math.max(0, initialDuration - elapsedSec);
                updateMgtTimerDisplay(mid, managementSeconds[mid]);
            }
        });
        seconds = 2400; updateTimerDisplay(); if (timerInterval) toggleTimer();
    }

    function timeStrToSeconds(str) { const parts = str.split(':'); return parseInt(parts[0]) * 60 + parseInt(parts[1]); }

    function menuAction(type) {
        if (selectedIds.length === 0) return;
        let p1 = playersMaster.find(x => x.id === selectedIds[0]) || ejectedPlayers.find(x => x.id === selectedIds[0]);
        let p2 = selectedIds.length >= 2 ? (playersMaster.find(x => x.id === selectedIds[1]) || ejectedPlayers.find(x => x.id === selectedIds[1])) : null;
        let actionType = type;

        if (selectedIds.length === 1) {
            let p1Idx = playersMaster.findIndex(x => x.id === selectedIds[0]);
            if (!['YC', 'RC', 'OFR', '負傷交代'].includes(type) && p1Idx !== -1 && p1Idx < 15) {
                if (!confirm(`${type}として予約リストに追加しますか？`)) return;
                addReservationCard(type + "（退出）", p1, null);
                clearSelection(); return;
            }
            if (type === '負傷交代') actionType = '負傷退場';
        }
        if (!validateCatLimit(selectedIds[0], selectedIds[1] || '', actionType)) return;
        addReservationCard(actionType, p1, p2); clearSelection();
    }

    function formatTimerStr(totalSeconds) {
        const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0'), s = (totalSeconds % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    }

    function addReservationCard(type, outP, inP, mid = null) {
        const resList = document.getElementById('reservation-list'), rid = mid || Date.now();
        const card = document.createElement('div'); card.className = 'reserve-card'; card.id = `res-${rid}`;
        card.dataset.outId = outP ? outP.id : ''; card.dataset.inId = inP ? inP.id : '';
        let displayType = type.replace('交代','').replace('確定',''), 
            outText = outP ? (outP.id === 'empty' ? 'OUT 空白' : `OUT No${outP.no} ${outP.name}`) : 'OUT ---', 
            inText = inP ? (inP.id === 'empty' ? 'IN&nbsp;&nbsp;空白' : `IN&nbsp;&nbsp;No${inP.no} ${inP.name}`) : 'IN&nbsp;&nbsp;空白';
        
        card.innerHTML = `<div class="reserve-remaining" id="res-timer-${rid}"></div><div class="reserve-info"><div style="color:var(--btn-green); font-weight:bold;">【${displayType}】 待機中...</div><div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${outText}</div><div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${inText}</div></div><div class="reserve-btns"><button class="btn-reserve-exe" onclick="handleReserveExe('${type}', '${outP?outP.id:''}', '${inP?inP.id:''}', ${rid})">実行</button><button class="btn-reserve-del" onclick="removeReservationCard(${rid})">削除</button></div>`;
        resList.prepend(card);
        if (mid && managementSeconds[mid] !== undefined) updateMgtTimerDisplay(rid, managementSeconds[rid]);
    }

    function removeReservationCard(rid) { 
        if (confirm("この予約を削除してもよろしいですか？")) {
            if (managementTimers[rid]) { clearInterval(managementTimers[rid]); delete managementTimers[rid]; delete managementSeconds[rid]; }
            const card = document.getElementById(`res-${rid}`); if(card) card.remove();
        }
    }

    function handleReserveExe(type, outId, inId, rid) {
        if (type.includes('確定')) {
            const outP = playersMaster.find(x => x.id === outId) || ejectedPlayers.find(x => x.id === outId);
            const inP = playersMaster.find(x => x.id === inId) || ejectedPlayers.find(x => x.id === inId);
            if (outP && outP.id !== 'empty') { 
                if (type.includes('戦術')) outP.status = 'status-tactical-out'; 
                else if (type.includes('負傷')) outP.status = 'status-injured-out'; 
                else outP.status = 'normal'; 
                addLog(type.replace('確定',''), outP, inP); 
            }
            if (managementTimers[rid]) { clearInterval(managementTimers[rid]); delete managementTimers[rid]; delete managementSeconds[rid]; }
            renderLists(); const card = document.getElementById(`res-${rid}`); if(card) card.remove(); checkFRConditions(); return;
        }

        let outIdx = playersMaster.findIndex(p => p.id === outId);
        let outP = outIdx !== -1 ? playersMaster[outIdx] : ejectedPlayers.find(p => p.id === outId);

        if (type.includes('（退出）')) {
            const originType = type.replace('（退出）','');
            const posNum = outIdx + 1;
            // 出血・HIA等の退出時は赤文字
            if(['出血交代','HIA','出血HIA'].includes(originType)) outP.status = 'status-treating';
            else outP.status = 'normal';

            ejectedPlayers.push({...outP, originalPos: posNum});
            playersMaster[outIdx] = { id: 'empty', no: '', name: '-----', cat: '', fr: '', status: 'normal' };
            addLog(originType + "（退出）", outP, null);
            createManagementCard(originType, outP, null, posNum, rid);
            const card = document.getElementById(`res-${rid}`); if(card) card.remove();
            renderLists(); checkFRConditions(); return;
        }

        if (['YC', 'RC', 'OFR'].includes(type)) {
            const posNum = outIdx + 1; addPenaltyLog(type, outP, ""); addLog(type, outP, null, "");
            ejectedPlayers.push({...outP, originalPos: posNum, status:'normal'}); 
            playersMaster[outIdx] = { id: 'empty', no: '', name: '-----', cat: '', fr: '', status: 'normal' };
            createManagementCard(type, outP, null, posNum, rid); 
            const card = document.getElementById(`res-${rid}`); if(card) card.remove(); 
            renderLists(); checkFRConditions();
        } else if (type === '負傷退場') {
            if (outIdx !== -1) { 
                const posNum = outIdx + 1; outP.status = 'status-injured-out'; 
                ejectedPlayers.push({...outP, originalPos: posNum}); 
                playersMaster[outIdx] = { id: 'empty', no: '', name: '-----', cat: '', fr: '', status: 'normal' }; 
                addLog("負傷退場", outP, null); 
            }
            const card = document.getElementById(`res-${rid}`); if(card) card.remove(); renderLists(); checkFRConditions();
        } else { executeSwap(type, outId, inId, rid); }
    }

    function checkFRConditions() {
        const p1 = playersMaster[0], p2 = playersMaster[1], p3 = playersMaster[2];
        let warning = (p1.id === 'empty' || !p1.fr.includes("1")) || (p2.id === 'empty' || !p2.fr.includes("2")) || (p3.id === 'empty' || !p3.fr.includes("3"));
        isUncontested = warning;
        document.getElementById('uncontested-banner').style.display = warning ? 'block' : 'none';
    }

    function executeSwap(type, outId, inId, rid) {
        let outIdx = playersMaster.findIndex(p => p.id === outId);
        let inIdx = playersMaster.findIndex(p => p.id === inId);
        if (outIdx !== -1 && inIdx !== -1) {
            const pOut = playersMaster[outIdx], pIn = playersMaster[inIdx];
            if (type === 'SWAP') { pIn.status = 'normal'; pOut.status = 'normal'; }
            else if (!type.includes('（')) {
                if (type.includes('戦術')) pOut.status = 'status-tactical-out';
                else if (type.includes('負傷')) pOut.status = 'status-injured-out';
                else if (['出血交代','HIA','出血HIA'].includes(type)) pOut.status = 'status-treating';
                else pOut.status = 'normal';
            }
            playersMaster[outIdx] = pIn; playersMaster[inIdx] = pOut;
            if (outIdx < 15) playersMaster[outIdx].status = 'normal';
            addLog(type, pOut, pIn);
            if (['出血交代','HIA','出血HIA','一時退出','SWAP'].includes(type)) createManagementCard(type, pOut, pIn, outIdx + 1, rid);
        }
        renderLists(); const card = document.getElementById(`res-${rid}`); if(card) card.remove(); checkFRConditions();
    }

    function createManagementCard(type, outP, inP, posNum, oldRid = null) {
        const mList = document.getElementById('management-list'), mid = oldRid || Date.now();
        const gameTime = document.getElementById('timer-display').innerText, pcTime = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        const card = document.createElement('div'); card.className = 'mgt-card'; card.id = `mgt-${mid}`;
        card.dataset.outId = outP ? outP.id : ''; card.dataset.inId = inP ? inP.id : ''; card.dataset.originType = type; card.dataset.posNum = posNum || ''; card.dataset.startTimeStr = gameTime;
        let statusBtns = (type === 'OFR') ? `<button id="btn-yellow-${mid}" class="active-yellow" onclick="selectOFRDecision(${mid}, 'YELLOW')">YELLOW</button><button id="btn-red-${mid}" onclick="selectOFRDecision(${mid}, 'RED')">RED</button><button class="btn-decision-exe" onclick="confirmOFRDecision(${mid})">判定</button><div id="ofr-sub-btns-${mid}" style="display:none; width:100%; gap:4px; margin-top:8px;"></div>` : 
                        (type === 'RC' ? `<button class="active-normal">交代</button>` : `<button id="btn-fukki-${mid}" class="active-normal" onclick="toggleMgtStatus(${mid}, '復帰')">復帰</button><button id="btn-senshu-${mid}" onclick="toggleMgtStatus(${mid}, '戦術')">戦術</button><button id="btn-fujou-${mid}" onclick="toggleMgtStatus(${mid}, '負傷')">負傷</button>`);
        
        let initialSeconds = (type === 'YC' || type === 'OFR') ? 600 : (type === 'RC' ? 1200 : (type === 'HIA' ? 720 : (type === '出血HIA' ? 1020 : 900)));
        card.innerHTML = `<div class="mgt-header"><div class="mgt-type">【${type}】${gameTime}</div><div class="mgt-timer" id="timer-${mid}">00:00</div></div><div class="mgt-player-info" id="mgt-info-${mid}"></div><div class="mgt-status-btns">${statusBtns}</div><div class="mgt-action-btns"><button class="btn-mgt-exe" onclick="executeMgtReturn(${mid})">実行</button><button class="btn-mgt-del" onclick="removeMgtCard(${mid})">削除</button></div>`;
        mList.prepend(card);
        if (['出血交代','HIA','出血HIA','一時退出','SWAP'].includes(type)) startIndependentMgtTimer(mid, initialSeconds); else startLinkedMgtTimer(mid, initialSeconds); updateMgtDisplay(mid);
    }

    function toggleMgtStatus(mid, status) {
        const btns = document.querySelectorAll(`#mgt-${mid} .mgt-status-btns button`);
        btns.forEach(b => b.classList.remove('active-normal'));
        event.target.classList.add('active-normal');
        updateMgtDisplay(mid);
    }

    function updateMgtDisplay(mid) {
        const card = document.getElementById(`mgt-${mid}`);
        const outP = playersMaster.find(x => x.id === card.dataset.outId) || ejectedPlayers.find(x => x.id === card.dataset.outId);
        const inP = playersMaster.find(x => x.id === card.dataset.inId);
        document.getElementById(`mgt-info-${mid}`).innerHTML = `OUT: No${outP?.no||''} ${outP?.name||''}<br>IN: No${inP?.no||''} ${inP?.name||''}`;
    }

    function executeMgtReturn(mid) {
        const card = document.getElementById(`mgt-${mid}`), type = card.dataset.originType;
        const outP = playersMaster.find(x => x.id === card.dataset.outId) || ejectedPlayers.find(x => x.id === card.dataset.outId);
        const inP = playersMaster.find(x => x.id === card.dataset.inId);
        addReservationCard(type + "（復帰）", inP, outP, mid);
        card.remove();
    }

    function renderLists() {
        const fList = document.getElementById('field-list'), bList = document.getElementById('bench-list'), eList = document.getElementById('ejected-list');
        fList.innerHTML = ''; bList.innerHTML = ''; eList.innerHTML = '';
        playersMaster.slice(0, 15).forEach((p, i) => fList.innerHTML += createRow(i + 1, p, 'field'));
        playersMaster.slice(15, 23).forEach((p, i) => bList.innerHTML += createRow(i + 16, p, 'bench'));
        ejectedPlayers.forEach(p => eList.innerHTML += createRow(p.originalPos, p, 'ejected'));
        updateCategoryDisplay();
    }

    function createRow(pos, p, type) {
        const s = p.status || '';
        return `<div class="player-row ${s} ${p.id==='empty'?'empty-row':''}" onclick="selectPlayer(this)" data-id="${p.id}">
            <div class="pos-circle ${type === 'field' ? 'field-circle' : (type === 'ejected' ? 'red-circle' : 'bench-circle')}">${pos}</div>
            <div class="jersey-no">${p.no ? 'No.' + p.no : ''}</div><div class="player-name">${p.name}</div>
            <div style="font-size:10px; opacity:0.6; text-align:center;">${p.cat}</div><div class="fr-cond">${p.fr}</div>
            ${type==='ejected'?`<button class="btn-ejected-del" onclick="removeEjectedPlayer(event, '${p.id}')">×</button>`:'<div></div>'}
        </div>`;
    }

    function addPenaltyLog(type, p, reason) {
        const gt = document.getElementById('timer-display').innerText, logId = 'plog-' + Date.now(), div = document.createElement('div');
        div.className = (type === 'YC' || type.includes('YELLOW')) ? 'log-entry yc-bg' : (type === 'RC' || type.includes('RED') ? 'log-entry rc-bg' : 'log-entry');
        div.innerHTML = `<b>【${type}】 ${gt}</b><br>No${p.no} ${p.name}`;
        document.getElementById('penalty-log').prepend(div);
    }

    function addLog(type, outP, inP, reason) {
        const gt = document.getElementById('timer-display').innerText, div = document.createElement('div');
        div.className = 'log-entry';
        div.innerHTML = `<b>【${type}】 ${gt}</b><br>${outP?`OUT: No${outP.no} `:''}${inP?`IN: No${inP.no}`:''}`;
        document.getElementById('main-log').prepend(div);
    }

    // タイマー制御
    function toggleTimer() { 
        const btn = document.getElementById('start-btn'); 
        if (timerInterval) { clearInterval(timerInterval); timerInterval = null; btn.innerText = "START"; btn.className = "btn-start-style"; } 
        else { timerInterval = setInterval(() => { seconds++; updateTimerDisplay(); }, 1000); btn.innerText = "STOP"; btn.className = "btn-stop-style"; } 
    }
    function updateTimerDisplay() { 
        let m = Math.floor(seconds/60).toString().padStart(2,'0'), s = (seconds%60).toString().padStart(2,'0'); 
        document.getElementById('timer-display').innerText = `${m}:${s}`; 
    }
    function resetTimer() { if (confirm("リセットしますか？")) { seconds = 0; updateTimerDisplay(); } }
    function startIndependentMgtTimer(mid, dur) { managementSeconds[mid] = dur; managementTimers[mid] = setInterval(() => { managementSeconds[mid]--; updateMgtTimerDisplay(mid, managementSeconds[mid]); if(managementSeconds[mid]<=0) clearInterval(managementTimers[mid]); }, 1000); }
    function startLinkedMgtTimer(mid, dur) { managementSeconds[mid] = dur; managementTimers[mid] = setInterval(() => { if(timerInterval){ managementSeconds[mid]--; updateMgtTimerDisplay(mid, managementSeconds[mid]); if(managementSeconds[mid]<=0) clearInterval(managementTimers[mid]); } }, 1000); }
    function updateMgtTimerDisplay(mid, s) { 
        const el = document.getElementById(`timer-${mid}`), res = document.getElementById(`res-timer-${mid}`); 
        if(el) el.innerText = formatTimerStr(s); if(res) res.innerText = formatTimerStr(s); 
    }

    function handleExcel(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
            document.getElementById('team-name-display').innerText = json[0] ? json[0][2] : "TEAM";
            playersMaster = []; initialMaster = [];
            for(let j=2; j<25; j++) {
                const r = json[j] || [];
                let frs = []; if(r[3]) frs.push(1); if(r[4]) frs.push(2); if(r[5]) frs.push(3);
                const p = { id:'p'+Math.random().toString(36).substr(2,9), no:r[0]||'', name:r[1]||'-----', cat:r[2]||'', fr:frs.join(' '), status:'normal' };
                playersMaster.push(p); initialMaster.push(JSON.parse(JSON.stringify(p)));
            }
            renderLists(); checkFRConditions();
        }; reader.readAsArrayBuffer(e.target.files[0]);
    }

    // 初期化用空データ
    playersMaster = Array.from({length:23}, (_,i)=>({id:'init'+i, no:'', name:'-----', cat:'', fr:'', status:'normal'}));
</script>
</body>
</html>
