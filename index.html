<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rugby Sub Manager - Pro 2026 v3.8.2</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-body: #f1f5f9; --bg-column: #ffffff; --border-color: #e2e8f0;
            --field-green: #059669; --bench-orange: #d97706; --text-main: #1e293b;
            --text-sub: #64748b; --text-medical: #dc2626; --text-tactical: #2563eb;
            --bg-injury: #cbd5e1; --text-injury: #475569;
            --color-yc: #facc15; --color-rc: #ef4444; --color-ofr: #f97316;
            --stopwatch-bg: #1e293b; --stopwatch-text: #34d399;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; user-select: none; }
        header { background: #fff; padding: 10px 20px; border-bottom: 2px solid var(--border-color); flex-shrink: 0; }
        .header-top { display: flex; justify-content: space-between; align-items: center; position: relative; }
        #team-name-display { font-weight: 900; font-size: 1.4rem; color: var(--text-main); }
        
        #uncontested-alert { display: none; background: #ef4444; color: white; padding: 4px 12px; border-radius: 6px; font-weight: 900; font-size: 0.9rem; position: absolute; left: 50%; transform: translateX(-50%); animation: blink 1s infinite; }
        @keyframes blink { 0% {opacity: 1;} 50% {opacity: 0.6;} 100% {opacity: 1;} }

        .stopwatch-panel { display: flex; align-items: center; gap: 12px; background: #f8fafc; padding: 6px 16px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
        #timer-display { font-family: 'JetBrains Mono', monospace; font-size: 2.2rem; font-weight: 800; color: var(--stopwatch-bg); min-width: 120px; text-align: center; letter-spacing: -1px; }
        .btn-sw { border: none; border-radius: 8px; padding: 8px 16px; font-weight: 800; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; color: #fff; text-transform: uppercase; display: flex; align-items: center; justify-content: center; min-width: 80px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-toggle-start { background: var(--field-green); }
        .btn-toggle-pause { background: var(--bench-orange); }
        .btn-reset { background: #64748b; }
        .btn-history { background: #94a3b8; min-width: 60px; }
        
        main { display: flex; gap: 10px; padding: 10px; flex-grow: 1; overflow: hidden; }
        .column { background: var(--bg-column); border-radius: 12px; border: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; height: 100%; width: 280px; flex-shrink: 0; }
        .col-res-admin { width: 420px; }
        h2 { font-size: 0.8rem; padding: 8px; background: #f8fafc; margin: 0; text-align: center; font-weight: 900; color: var(--text-sub); border-bottom: 1px solid var(--border-color); text-transform: uppercase; letter-spacing: 1px; }
        .scroll-area { flex-grow: 1; overflow-y: auto; padding: 8px; }
        
        .player-card { height: 34px; margin-bottom: 4px; border: 1px solid var(--border-color); border-radius: 6px; display: flex; align-items: center; background: #fff; padding: 0 6px; font-weight: 700; font-size: 0.85rem; cursor: grab; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative; }
        .player-card.empty-slot { background: #f8fafc; border: 1px dashed var(--border-color); cursor: default; }
        .pos-label { width: 22px; color: var(--text-sub); font-size: 0.7rem; border-right: 1px solid #eee; margin-right: 8px; text-align: center; flex-shrink: 0; }
        .name-area { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; text-align: left; }
        .attr-tag { font-size: 0.6rem; padding: 2px 5px; border-radius: 4px; margin-left: 4px; font-weight: 900; color: #fff; flex-shrink: 0; }
        .cat-tag { background: #64748b; }
        .fr-tag { background: #ef4444; }

        .color-normal { color: #000 !important; }
        .color-medical { color: var(--text-medical) !important; }
        .color-tactical { color: var(--text-tactical) !important; }
        .bg-injury { background-color: var(--bg-injury) !important; color: var(--text-injury) !important; pointer-events: none; }
        
        .status-yc { background-color: #fef9c3 !important; border-color: var(--color-yc) !important; }
        .status-rc { background-color: #fee2e2 !important; border-color: var(--color-rc) !important; }
        .status-ofr { background-color: #ffedd5 !important; border-color: var(--color-ofr) !important; }
        
        .res-card, .admin-card { background: #fff; border: 2px solid var(--border-color); border-left: 5px solid var(--bench-orange); border-radius: 8px; padding: 6px; margin-bottom: 8px; position: relative; font-size: 0.85rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .btn-delete { position: absolute; top: 4px; right: 4px; background: #fee2e2; color: #ef4444; border: none; border-radius: 4px; cursor: pointer; padding: 1px 5px; font-weight: 800; z-index: 20; font-size: 0.7rem; }
        .card-row { margin-bottom: 3px; display: flex; align-items: center; gap: 15px; }
        .card-row span:first-child { width: 35px; font-weight: 800; color: var(--text-sub); font-size: 0.75rem; text-align: left; }
        .card-row b { flex-grow: 1; text-align: left; color: #000; }
        .card-row.in-row b { color: var(--field-green); }
        
        .btn-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin: 4px 0; }
        .btn-group button { font-size: 0.75rem; padding: 4px 0; cursor: pointer; font-weight: 800; border: 1px solid #e2e8f0; border-radius: 6px; background: #fff; transition: 0.2s; position: relative; z-index: 10; }
        .btn-group button.active-tactical { background: var(--text-tactical); color: #fff; border-color: var(--text-tactical); }
        .btn-group button.active-injury { background: #64748b; color: #fff; border-color: #64748b; }
        .btn-group button.active-medical { background: var(--text-medical); color: #fff; border-color: var(--text-medical); }
        .btn-group button.active-return { background: var(--field-green); color: #fff; border-color: var(--field-green); }
        .btn-group button.active-yc { background: var(--color-yc); color: #000; border-color: var(--color-yc); }
        .btn-group button.active-rc { background: var(--color-rc); color: #fff; border-color: var(--color-rc); }
        .btn-group button.active-ofr { background: var(--color-ofr); color: #fff; border-color: var(--color-ofr); }
        .btn-group button.active-temporary { background: #1e293b; color: #fff; border-color: #1e293b; }
        
        .btn-exec, .btn-go-res { background: var(--field-green); color: white; border: none; width: 100%; height: 32px; border-radius: 8px; font-weight: 900; cursor: pointer; font-size: 0.85rem; margin-top: 4px; position: relative; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-go-res { background: #475569; }
        
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; padding-right: 25px; }
        .admin-times { font-size: 0.75rem; color: var(--text-sub); font-family: monospace; }
        .admin-countdown { font-size: 1.1rem; color: var(--text-medical); font-weight: 900; font-family: 'JetBrains Mono'; }
        
        .log-item { font-size: 11px; border-bottom: 1px solid #eee; padding: 6px; line-height: 1.4; border-radius: 4px; margin-bottom: 2px; }
        .log-yc { background-color: var(--color-yc); color: #000; }
        .log-rc { background-color: var(--color-rc); color: #fff; }
        .log-ofr { background-color: var(--color-ofr); color: #fff; }
        
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 300px; max-height: 80vh; overflow-y: auto; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-player-btn { width: 100%; padding: 10px; margin-bottom: 5px; border: 1px solid var(--border-color); border-radius: 6px; background: white; font-weight: 700; cursor: pointer; text-align: left; }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <div id="team-name-display">Drop Excel to Load Team</div>
        <div id="uncontested-alert">Uncontested scrum</div>
        <div class="stopwatch-panel">
            <div id="timer-display">00:00</div>
            <button id="btn-toggle" class="btn-sw btn-toggle-start" onclick="toggleTimer()">START</button>
            <button class="btn-sw btn-reset" onclick="resetTimer()">RESET</button>
            <button class="btn-sw btn-history" onclick="undo()" title="Undo">UNDO</button>
            <button class="btn-sw btn-history" onclick="redo()" title="Redo">REDO</button>
        </div>
    </div>
</header>

<main>
    <div class="column"><h2>Field</h2><div id="field-list" class="scroll-area"></div></div>
    <div class="column"><h2>Bench</h2><div id="bench-list" class="scroll-area"></div></div>
    <div class="col-res-admin">
        <div class="column" style="height: 48%; width: 100%;" ondragover="e=>e.preventDefault()" ondrop="dropToRes(event)">
            <h2>Reservations</h2>
            <div id="res-list" class="scroll-area"></div>
        </div>
        <div class="column" style="height: 50%; width: 100%; margin-top: 2%;"><h2>Trackers</h2><div id="admin-list" class="scroll-area"></div></div>
    </div>
    <div class="column" style="flex-grow:1"><h2>Log</h2><div id="log-list" class="scroll-area"></div></div>
</main>

<div id="modal-overlay">
    <div class="modal-content">
        <h3>Select Player</h3>
        <div id="modal-player-list"></div>
        <button onclick="closeModal()" style="margin-top:10px; padding:8px 15px; border-radius:6px; border:none; background:#64748b; color:white; font-weight:800; cursor:pointer;">Cancel</button>
    </div>
</div>

<script>
    let fieldPositions = Array.from({length: 15}, (_, i) => ({ posId: i+1, player: null }));
    let benchPlayers = [], reservations = [], adminCards = [], logs = [];
    let elapsedTime = 0, timerInterval = null, lastTick = Date.now();
    let currentSelectionContext = null;
    let historyStack = [], redoStack = [];

    function getPCNow() {
        const d = new Date();
        return [d.getHours(), d.getMinutes(), d.getSeconds()].map(v => String(v).padStart(2,'0')).join(':');
    }

    function isMedicalType(type) { return ['Blood bin', 'HIA', 'B/HIA'].includes(type); }

    function toggleTimer() {
        const btn = document.getElementById('btn-toggle');
        if (!timerInterval) {
            lastTick = Date.now();
            timerInterval = setInterval(tick, 100);
            btn.innerText = 'PAUSE'; btn.className = 'btn-sw btn-toggle-pause';
        } else {
            clearInterval(timerInterval);
            timerInterval = null;
            btn.innerText = 'START'; btn.className = 'btn-sw btn-toggle-start';
        }
    }

    function resetTimer() {
        if (confirm("経過時間を00:00にリセットしますか？")) {
            saveHistory(); elapsedTime = 0;
            if (timerInterval) toggleTimer(); 
            document.getElementById('timer-display').innerText = "00:00";
        }
    }

    function tick() {
        const now = Date.now(); const delta = now - lastTick; lastTick = now;
        if (timerInterval) elapsedTime += delta; 
        adminCards.forEach(c => { if (c.remainingMs !== undefined) { if (isMedicalType(c.type) || timerInterval) c.remainingMs = Math.max(0, c.remainingMs - delta); } });
        reservations.forEach(r => { if (r.remainingMs !== undefined) { if (isMedicalType(r.adminType) || timerInterval) r.remainingMs = Math.max(0, r.remainingMs - delta); } });
        document.getElementById('timer-display').innerText = formatTime(elapsedTime);
        adminCards.forEach(c => { const el = document.getElementById(`admin-time-${c.id}`); if (el) el.innerText = formatTime(c.remainingMs); });
        reservations.forEach(r => { if(r.isFromAdmin) { const el = document.getElementById(`res-time-${r.id}`); if(el) el.innerText = formatTime(r.remainingMs); }});
    }

    function getCurrentState() { return JSON.stringify({ fieldPositions, benchPlayers, reservations, adminCards, logs }); }
    function saveHistory() { historyStack.push(getCurrentState()); if (historyStack.length > 50) historyStack.shift(); redoStack = []; }
    function undo() { if (historyStack.length === 0) return; redoStack.push(getCurrentState()); applyState(historyStack.pop()); }
    function redo() { if (redoStack.length === 0) return; historyStack.push(getCurrentState()); applyState(redoStack.pop()); }
    function applyState(stateStr) { const state = JSON.parse(stateStr); fieldPositions = state.fieldPositions; benchPlayers = state.benchPlayers; reservations = state.reservations; adminCards = state.adminCards; logs = state.logs; render(); }

    function dropToRes(e) { 
        e.preventDefault(); 
        if (window.dragged?.source === 'field') { 
            if (!validateFR(window.dragged.item.player, null, window.dragged.item.posId)) return;
            saveHistory(); createCardReservation(window.dragged.item.player, window.dragged.item.posId); 
        } 
    }

    function processExcel(data) {
        saveHistory();
        if (data[0] && data[0][0]) document.getElementById('team-name-display').innerText = data[0][0];
        const ps = [];
        for (let i = 2; i < data.length; i++) {
            const row = data[i]; if (!row || !row[0]) continue;
            const fr = [];
            if (String(row[3]).toLowerCase()==='true') fr.push('1');
            if (String(row[4]).toLowerCase()==='true') fr.push('2');
            if (String(row[5]).toLowerCase()==='true') fr.push('3');
            ps.push({ id: 'P'+row[0], no: row[0], name: row[1], cat: row[2]||'', fr: fr, status: 'normal' });
        }
        fieldPositions = ps.filter(p => p.no <= 15).map((p, idx) => ({ posId: idx+1, player: p }));
        benchPlayers = ps.filter(p => p.no > 15);
        render();
    }

    function checkFRCompliance() {
        let uncontested = false;
        [1, 2, 3].forEach(posId => {
            const p = fieldPositions.find(fp => fp.posId === posId)?.player;
            if (!p || !p.fr || !p.fr.includes(String(posId))) {
                uncontested = true;
            }
        });
        document.getElementById('uncontested-alert').style.display = uncontested ? 'block' : 'none';
    }

    function validateFR(outP, inP, posId) {
        if (![1, 2, 3].includes(posId)) return true;
        const isCompliant = inP && inP.fr && inP.fr.includes(String(posId));
        if (!isCompliant) {
            const msg = !inP 
                ? `フロントロー(#${posId})が不在になります。アンコンテスト・スクラムになりますがよろしいですか？`
                : `交代選手(#${inP.no})はフロントロー(#${posId})の資格がありません。アンコンテスト・スクラムになりますがよろしいですか？`;
            return confirm(msg);
        }
        return true;
    }

    function render() {
        const fl = document.getElementById('field-list'); fl.innerHTML = '';
        fieldPositions.forEach(item => {
            const div = document.createElement('div'); div.className = 'player-card';
            const p = item.player;
            div.innerHTML = `<span class="pos-label">${item.posId}</span><span class="name-area color-normal">#${p ? p.no+' '+p.name : '---'}</span>
                ${p?.cat ? `<span class="attr-tag cat-tag">${p.cat}</span>` : ''}
                ${p?.fr?.length ? `<span class="attr-tag fr-tag">${p.fr.join('')}</span>` : ''}`;
            div.draggable = true; 
            div.ondragstart = () => { window.dragged = {source:'field', item}; }; 
            div.ondragover = e => e.preventDefault();
            div.ondrop = e => { 
                e.stopPropagation();
                if (window.dragged?.source === 'bench') {
                    if (!validateFR(item.player, window.dragged.p, item.posId)) return;
                    saveHistory(); createReservation(item.player, window.dragged.p, item.posId, window.dragged.index);
                } else if (window.dragged?.source === 'field') {
                    if (!validateFR(item.player, window.dragged.item.player, item.posId)) return;
                    if (!validateFR(window.dragged.item.player, item.player, window.dragged.item.posId)) return;
                    saveHistory(); swapPlayers(window.dragged.item, item);
                }
            };
            fl.appendChild(div);
        });

        const bl = document.getElementById('bench-list'); bl.innerHTML = '';
        benchPlayers.forEach((p, idx) => {
            const div = document.createElement('div');
            if (p === null) {
                div.className = 'player-card empty-slot';
                div.innerHTML = `<span class="name-area" style="color:#cbd5e1;">(EMPTY SLOT)</span>`;
                div.draggable = false;
            } else {
                let cls = p.status === 'medical_red' ? 'color-medical' : (p.status === 'tactical' ? 'color-tactical' : 'color-normal');
                let statusClass = p.status === 'yc' ? 'status-yc' : (p.status === 'rc' ? 'status-rc' : (p.status === 'ofr' ? 'status-ofr' : ''));
                div.className = `player-card ${['injury','rc'].includes(p.status) ? 'bg-injury' : ''} ${statusClass}`;
                div.innerHTML = `<span class="name-area ${cls}">#${p.no} ${p.name}</span>
                    ${p.cat ? `<span class="attr-tag cat-tag">${p.cat}</span>` : ''}
                    ${p.fr?.length ? `<span class="attr-tag fr-tag">${p.fr.join('')}</span>` : ''}`;
                div.draggable = !['injury', 'rc'].includes(p.status);
                div.ondragstart = () => window.dragged = {source:'bench', p, index: idx};
            }
            div.ondragover = e => e.preventDefault();
            div.ondrop = e => {
                e.stopPropagation();
                if (window.dragged?.source === 'field') { 
                    if (!validateFR(window.dragged.item.player, p, window.dragged.item.posId)) return;
                    saveHistory(); createReservation(window.dragged.item.player, p, window.dragged.item.posId, idx); 
                }
            };
            bl.appendChild(div);
        });
        checkFRCompliance(); renderRes(); renderAdmin(); renderLogs();
    }

    function swapPlayers(sourceItem, targetItem) {
        if (sourceItem.posId === targetItem.posId) return;
        const pA = sourceItem.player; const pB = targetItem.player;
        if(pA) pA.status = 'normal';
        if(pB) pB.status = 'normal';
        sourceItem.player = pB; targetItem.player = pA;
        logs.unshift({ type: 'SWAP', matchTime: formatTime(elapsedTime), pcTime: getPCNow(), out: pA, in: pB, isColor: false });
        render();
    }

    function createReservation(outP, inP, posId, benchIndex) {
        reservations.push({ id: Date.now(), out: outP, in: inP, posId: posId, benchIdx: benchIndex, type: 'Tactical', isFromAdmin: false, isCard: false });
        render();
    }

    function createCardReservation(outP, posId) {
        reservations.push({ id: Date.now(), out: outP, in: null, posId: posId, type: 'YELLOW', isCard: true });
        render();
    }

    function renderRes() {
        const el = document.getElementById('res-list'); el.innerHTML = '';
        reservations.forEach(r => {
            const div = document.createElement('div'); div.className = 'res-card';
            const outName = r.out ? `#${r.out.no} ${r.out.name}` : '(NONE)';
            const inName = r.in ? `#${r.in.no} ${r.in.name}` : '(NONE)';
            if (r.isCard) {
                div.innerHTML = `<button class="btn-delete" onclick="delItem('res',${r.id})">×</button>
                    <div class="card-row"><span>OUT</span><b class="color-normal">${outName}</b></div>
                    <div class="btn-group">
                        <button class="${r.type==='YELLOW'?'active-yc':''}" onclick="setResType(${r.id},'YELLOW')">YELLOW</button>
                        <button class="${r.type==='RED'?'active-rc':''}" onclick="setResType(${r.id},'RED')">RED</button>
                        <button class="${r.type==='OFR'?'active-ofr':''}" onclick="setResType(${r.id},'OFR')">OFR</button>
                    </div>
                    <button class="btn-exec" onclick="executeRes(${r.id})">Execute</button>`;
            } else {
                let adminInfo = '';
                if (r.isFromAdmin) {
                    const timeStr = r.remainingMs !== undefined ? ` (<span id="res-time-${r.id}">${formatTime(r.remainingMs)}</span>)` : '';
                    adminInfo = `<div style="padding:4px 0; font-weight:800; color:var(--text-medical); border-top:1px dashed #ddd;">Pending: ${r.adminType} → ${r.type}${timeStr}</div>`;
                }
                div.innerHTML = `<button class="btn-delete" onclick="delItem('res',${r.id})">×</button>
                    <div class="card-row"><span>OUT</span><b class="color-normal">${outName}</b></div>
                    <div class="card-row in-row"><span>IN</span><b>${inName}</b></div>
                    ${!r.isFromAdmin ? `
                    <div class="btn-group">
                        <button class="${r.type==='Tactical'?'active-tactical':''}" onclick="setResType(${r.id},'Tactical')">Tactical</button>
                        <button class="${r.type==='Injury'?'active-injury':''}" onclick="setResType(${r.id},'Injury')">Injury</button>
                        <button class="${r.type==='Blood bin'?'active-medical':''}" onclick="setResType(${r.id},'Blood bin')">Blood</button>
                        <button class="${r.type==='HIA'?'active-medical':''}" onclick="setResType(${r.id},'HIA')">HIA</button>
                        <button class="${r.type==='B/HIA'?'active-medical':''}" onclick="setResType(${r.id},'B/HIA')">B/HIA</button>
                        <button class="${r.type==='Temporary'?'active-temporary':''}" onclick="setResType(${r.id},'Temporary')">Temporary</button>
                    </div>` : adminInfo}
                    <button class="btn-exec" onclick="executeRes(${r.id})">Execute</button>`;
            }
            el.appendChild(div);
        });
    }

    function setResType(id, type) { saveHistory(); const r = reservations.find(x => x.id === id); if(r) r.type = type; renderRes(); }

    function executeRes(id) {
        saveHistory(); 
        const r = reservations.find(x => x.id === id); if (!r) return;
        const f = fieldPositions.find(p => p.posId === r.posId);
        const matchTime = formatTime(elapsedTime);
        const pcTime = getPCNow();

        const cleanupBench = (player) => {
            if (!player) return;
            benchPlayers = benchPlayers.map(p => (p && p.id === player.id) ? null : p);
        };
        cleanupBench(r.out);
        cleanupBench(r.in);

        if (r.isCard) {
            const statusMap = { 'YELLOW': 'yc', 'RED': 'rc', 'OFR': 'ofr' };
            logs.unshift({ type: r.type, matchTime: matchTime, pcTime: pcTime, out: r.out, in: null, isColor: true });
            if (r.out) {
                const updatedPlayer = {...r.out, status: statusMap[r.type]};
                const emptyIdx = benchPlayers.indexOf(null);
                if (emptyIdx !== -1) benchPlayers[emptyIdx] = updatedPlayer;
                else benchPlayers.push(updatedPlayer);
            }
            f.player = null;
            adminCards.push({ id: Date.now(), type: r.type, out: r.out, in: null, posId: r.posId, matchTime: matchTime, pcTime: pcTime, remainingMs: 600000, nextAction: r.type === 'RED' ? 'Replacement' : 'Return', reason: '', ofrDecision: null });
        } else if (r.type === 'Temporary') {
            const currentFieldPlayer = f.player;
            const currentBenchPlayer = r.in;
            if(currentFieldPlayer) currentFieldPlayer.status = 'normal';
            if(currentBenchPlayer) currentBenchPlayer.status = 'normal';
            f.player = currentBenchPlayer;
            if (r.benchIdx !== undefined && r.benchIdx < benchPlayers.length) {
                benchPlayers[r.benchIdx] = currentFieldPlayer;
            } else {
                const eIdx = benchPlayers.indexOf(null);
                if (eIdx !== -1) benchPlayers[eIdx] = currentFieldPlayer;
                else benchPlayers.push(currentFieldPlayer);
            }
            logs.unshift({ type: 'Temporary (SWAP)', matchTime: matchTime, pcTime: pcTime, out: currentFieldPlayer, in: currentBenchPlayer, isColor: false });
        } else {
            if (r.out) {
                let s = 'normal';
                if(r.adminType === 'RED' || r.type === 'RED' || r.ofrDecision === 'RED UPGRADE') s = 'rc';
                else if(r.type === 'Tactical') s = 'tactical';
                else if(r.type === 'Injury') s = 'injury';
                if (isMedicalType(r.type) && !r.isFromAdmin) {
                    s = 'medical_red';
                    const mins = r.type === 'Blood bin' ? 15 : (r.type === 'HIA' ? 12 : 17);
                    adminCards.push({ id: Date.now(), type: r.type, out: {...r.out, status:'medical_red'}, in: r.in, posId: r.posId, matchTime: matchTime, pcTime: pcTime, remainingMs: mins * 60000, nextAction: 'Return' });
                }
                const outPlayer = {...r.out, status: s};
                if (r.benchIdx !== undefined && r.benchIdx < benchPlayers.length) benchPlayers[r.benchIdx] = outPlayer;
                else {
                    const idx = benchPlayers.indexOf(null);
                    if (idx !== -1) benchPlayers[idx] = outPlayer;
                    else benchPlayers.push(outPlayer);
                }
            }
            if(r.in) r.in.status = 'normal';
            f.player = r.in;
            logs.unshift({ type: r.isFromAdmin ? `${r.adminType} (${r.type})` : r.type, matchTime: matchTime, pcTime: pcTime, out: r.out, in: r.in });
        }
        reservations = reservations.filter(x => x.id !== id); render();
    }

    function renderAdmin() {
        const el = document.getElementById('admin-list'); el.innerHTML = '';
        adminCards.forEach(c => {
            const div = document.createElement('div'); div.className = 'admin-card';
            div.ondragover = e => e.preventDefault();
            div.ondrop = e => {
                e.stopPropagation();
                if (window.dragged) {
                    const dp = window.dragged.source === 'field' ? window.dragged.item.player : window.dragged.p;
                    if (dp) {
                        saveHistory();
                        if (!validateFR(c.out, dp, c.posId)) return;
                        c.in = dp;
                        c.benchIdx = window.dragged.source === 'bench' ? window.dragged.index : undefined;
                        renderAdmin();
                    }
                }
            };
            const displayTime = formatTime(c.remainingMs);
            const pOutName = c.out ? `#${c.out.no} ${c.out.name}` : '(NONE)';
            const pInName = c.in ? `#${c.in.no} ${c.in.name}` : '(NONE)';
            if (['YELLOW','RED','OFR'].includes(c.type)) {
                let content = `<button class="btn-delete" onclick="delItem('admin',${c.id})">×</button>
                    <div class="admin-header"><span style="font-weight:900;">${c.type}</span><span class="admin-times">${c.matchTime}/${c.pcTime}</span><span class="admin-countdown" id="admin-time-${c.id}">${displayTime}</span></div>
                    <div class="card-row"><span>OUT</span><b class="color-normal">${pOutName}</b></div>
                    <div class="card-row in-row"><span>IN</span><b>${pInName}</b></div>`;
                if(c.type === 'OFR' && !c.ofrDecision) {
                    content += `<div class="btn-group" style="grid-template-columns: 1fr 1fr; margin-top:4px;"><button onclick="setOfrDecision(${c.id},'YELLOW STAY')">YELLOW STAY</button><button onclick="setOfrDecision(${c.id},'RED UPGRADE')">RED UPGRADE</button></div>`;
                } else {
                    const mode = (c.ofrDecision === 'RED UPGRADE' || c.type === 'RED') ? 'RED' : 'YELLOW';
                    content += `<div class="btn-group">
                        ${mode === 'YELLOW' ? `<button class="${c.nextAction==='Return'?'active-return':''}" onclick="setAdminNext(${c.id},'Return')">Return</button><button class="${c.nextAction==='Tactical'?'active-tactical':''}" onclick="setAdminNext(${c.id},'Tactical')">Tac</button><button class="${c.nextAction==='Injury'?'active-injury':''}" onclick="setAdminNext(${c.id},'Injury')">Inj</button>` 
                        : `<button style="grid-column: span 3;" class="${c.nextAction==='Replacement'?'active-tactical':''}" onclick="setAdminNext(${c.id},'Replacement')">Replacement</button>`}
                    </div><button class="btn-go-res" onclick="returnToRes(${c.id})">Go to reservation</button>`;
                }
                div.innerHTML = content;
            } else {
                let inner = `<button class="btn-delete" onclick="delItem('admin',${c.id})">×</button>
                    <div class="admin-header"><span style="font-weight:900;">${c.type}</span><span class="admin-times">${c.matchTime}/${c.pcTime}</span><span class="admin-countdown" id="admin-time-${c.id}">${displayTime}</span></div>`;
                if (c.nextAction === 'Return') inner += `<div class="card-row"><span>OUT</span><b>${pInName}</b></div><div class="card-row in-row"><span>IN</span><b class="color-medical">${pOutName}</b></div>`;
                else inner += `<div class="card-row"><span>STAY</span><b>${pOutName}</b></div><div class="card-row"><span>FIELD</span><b>${pInName} (Keep)</b></div>`;
                inner += `<div class="btn-group"><button class="${c.nextAction==='Return'?'active-return':''}" onclick="setAdminNext(${c.id},'Return')">Return</button><button class="${c.nextAction==='Tactical'?'active-tactical':''}" onclick="setAdminNext(${c.id},'Tactical')">Tac</button><button class="${c.nextAction==='Injury'?'active-injury':''}" onclick="setAdminNext(${c.id},'Injury')">Inj</button></div><button class="btn-go-res" onclick="returnToRes(${c.id})">Go to reservation</button>`;
                div.innerHTML = inner;
            }
            el.appendChild(div);
        });
    }

    function setAdminNext(id, act) { 
        saveHistory(); const c = adminCards.find(x => x.id === id); if (!c) return; 
        c.nextAction = act;
        if(['Tactical','Injury','Replacement'].includes(act)) {
            renderAdmin(); openPlayerModal(id);
        } else {
            if (act === 'Return' && ['YELLOW','RED','OFR'].includes(c.type)) c.in = null;
            renderAdmin();
        }
    }

    function setOfrDecision(id, d) {
        saveHistory(); const c = adminCards.find(x => x.id === id); if(!c) return;
        c.ofrDecision = d;
        // OFRの決定をログに記録
        logs.unshift({ type: `OFR DECISION: ${d}`, matchTime: formatTime(elapsedTime), pcTime: getPCNow(), out: c.out, in: null, isColor: true });
        
        if(d === 'RED UPGRADE') {
            c.nextAction = 'Replacement'; c.remainingMs += 600000; renderAdmin(); openPlayerModal(id);
        } else {
            c.nextAction = 'Return'; render();
        }
    }

    function openPlayerModal(cid) {
        currentSelectionContext = cid; const list = document.getElementById('modal-player-list'); list.innerHTML = '';
        const card = adminCards.find(x => x.id === cid);
        benchPlayers.forEach((p, idx) => {
            if (p !== null && !['rc', 'injury'].includes(p.status)) {
                const b = document.createElement('button'); b.className = 'modal-player-btn'; b.innerText = `#${p.no} ${p.name}`;
                b.onclick = () => { 
                    if (card && !validateFR(card.out, p, card.posId)) return;
                    if(card) { card.in = p; card.benchIdx = idx; }
                    closeModal(); renderAdmin(); 
                };
                list.appendChild(b);
            }
        });
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    function returnToRes(id) {
        saveHistory(); const c = adminCards.find(x => x.id === id); if (!c) return;
        if (['YELLOW', 'RED', 'OFR'].includes(c.type) && ['Tactical', 'Injury', 'Replacement'].includes(c.nextAction) && !c.in) {
            alert("交代する選手を選択してください。"); return;
        }
        let outP, inP;
        if (c.nextAction === 'Return') { outP = c.in; inP = c.out; } else { outP = c.out; inP = c.in; }
        reservations.push({ id: Date.now(), out: outP, in: inP, posId: c.posId, benchIdx: c.benchIdx, type: c.nextAction === 'Replacement' ? 'Tactical' : c.nextAction, isFromAdmin: true, adminType: c.type, origMatchTime: c.matchTime, remainingMs: c.remainingMs, ofrDecision: c.ofrDecision });
        adminCards = adminCards.filter(x => x.id !== id); render();
    }

    function formatTime(ms) { const s = Math.floor(Math.max(0, ms) / 1000); return String(Math.floor(s/60)).padStart(2,'0') + ':' + String(s%60).padStart(2,'0'); }
    function delItem(t, id) { saveHistory(); if(t==='res') reservations = reservations.filter(x=>x.id!==id); else adminCards = adminCards.filter(x=>x.id!==id); render(); }
    
    function renderLogs() {
        const el = document.getElementById('log-list'); el.innerHTML = '';
        logs.forEach(l => {
            const div = document.createElement('div'); let cls = '';
            if (l.isColor) { 
                if (l.type.includes('YELLOW')) cls = 'log-yc'; else if (l.type.includes('RED')) cls = 'log-rc'; else if (l.type.includes('OFR')) cls = 'log-ofr'; 
            }
            div.className = `log-item ${cls}`;
            div.innerHTML = `<b>${l.type || '--'}</b> [${l.matchTime}] (${l.pcTime})<br>OUT:#${l.out?.no || '--'} ${l.out?.name || '(NONE)'}${l.in ? `<br>IN:#${l.in.no} ${l.in.name}` : ''}`;
            el.appendChild(div);
        });
    }

    document.body.addEventListener('dragover', e => e.preventDefault());
    document.body.addEventListener('drop', e => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file && file.name.endsWith('.xlsx')) {
            const reader = new FileReader();
            reader.onload = ev => {
                const wb = XLSX.read(new Uint8Array(ev.target.result), {type: 'array'});
                processExcel(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1}));
            };
            reader.readAsArrayBuffer(file);
        }
    });
    setInterval(tick, 100);
</script>
</body>
</html>
