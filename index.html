<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rugby Sub Manager - Fixed Layout</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-body: #f4f7f6;
            --field-green: #27ae60;
            --bench-orange: #e67e22;
            --text-black: #000000;
            --text-medical: #ff0000;
            --text-tactical: #0000ff;
            --bg-injury: #d3d3d3;
            --bg-reserved: #fff9c4;
            --bg-yc: #ffff00;
            --bg-ofr: #ffcc80;
            --bg-rc: #e74c3c;
            --border: #bdc3c7;
        }

        body { font-family: -apple-system, sans-serif; background: var(--bg-body); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; user-select: none; }
        header { background: #2c3e50; color: white; padding: 4px 15px; flex-shrink: 0; }
        .header-top { display: flex; justify-content: space-between; align-items: center; height: 35px; }
        .stopwatch-container { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); padding: 2px 10px; border-radius: 20px; }
        #timer-display { font-family: monospace; font-size: 1.4rem; font-weight: bold; min-width: 80px; text-align: center; color: #00ff00; }
        .sw-btn { padding: 2px 8px; font-size: 0.7rem; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; }
        .btn-start { background: #27ae60; color: white; }
        .btn-pause { background: #f1c40f; color: black; }
        .btn-reset { background: #e74c3c; color: white; }
        .stats-bar { display: flex; gap: 15px; font-size: 0.8rem; background: rgba(0,0,0,0.2); padding: 2px 10px; border-radius: 4px; margin-bottom: 4px; }

        /* レイアウト幅の固定設定 */
        main { display: flex; gap: 8px; padding: 8px; flex-grow: 1; overflow: hidden; }
        .col-field { width: 250px; flex-shrink: 0; }
        .col-bench { width: 250px; flex-shrink: 0; }
        .col-res-admin { width: 320px; flex-shrink: 0; display: flex; flex-direction: column; gap: 8px; }
        .col-log { flex-grow: 1; min-width: 150px; }

        .column { background: white; border-radius: 8px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; height: 100%; }
        h2 { font-size: 0.8rem; margin: 0; padding: 6px; background: #f8f9fa; border-bottom: 1px solid #eee; text-align: center; font-weight: bold; }
        .scroll-area { flex-grow: 1; overflow-y: auto; padding: 6px; }

        .player-card { height: 40px; margin-bottom: 4px; border: 1px solid #ddd; border-radius: 6px; display: flex; align-items: center; background: #fff; position: relative; }
        .is-reserved { background-color: var(--bg-reserved) !important; border-color: #fbc02d !important; }
        .pos-label { width: 28px; height: 100%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; border-right: 1px solid #ddd; border-radius: 6px 0 0 6px; }
        .player-info { flex-grow: 1; padding-left: 6px; display: flex; align-items: center; font-weight: bold; overflow: hidden; color: var(--text-black); gap: 6px; }
        .jersey-no { font-size: 0.9rem; min-width: 20px; }
        .player-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; font-size: 0.85rem; }
        .player-cat { font-size: 0.65rem; color: #666; font-weight: normal; }
        .player-fr-num { font-size: 0.75rem; color: #d35400; font-weight: bold; white-space: nowrap; }

        .res-card, .admin-card { background: #fffde7; border: 2px solid #fbc02d; border-radius: 8px; padding: 8px; margin-bottom: 10px; position: relative; color: #000; }
        .admin-card { background: #fff; border: 1px solid #bdc3c7; }
        .btn-delete { position: absolute; top: 2px; right: 2px; width: 24px; height: 24px; background: #e74c3c; color: white; border: none; border-radius: 50%; font-size: 16px; cursor: pointer; z-index: 15; }
        .res-header { font-weight: bold; font-size: 0.95rem; border-bottom: 1px solid #ddd; margin-bottom: 8px; padding-bottom: 4px; color: #2c3e50; display: flex; justify-content: space-between; }
        .res-player-line { display: flex; flex-direction: column; gap: 4px; margin: 8px 0; font-weight: bold; font-size: 1rem; }
        .line-row { display: flex; align-items: center; }
        .line-label { font-size: 0.7rem; width: 30px; color: #666; }
        .res-no { min-width: 25px; }
        .res-player-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .res-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 10px; }
        .res-actions button { padding: 8px 2px; font-size: 0.85rem; font-weight: bold; border-radius: 6px; border: 1px solid #aaa; background: #fff; cursor: pointer; }
        .btn-execute-large { grid-column: span 3; padding: 12px !important; background: #27ae60 !important; color: white !important; font-size: 1.1rem !important; }

        .status-medical { color: var(--text-medical) !important; }
        .status-tactical { color: var(--text-tactical) !important; }
        .status-injury { background-color: var(--bg-injury) !important; }
        .status-yc { background-color: var(--bg-yc) !important; color: #000 !important; }
        .status-ofr { background-color: var(--bg-ofr) !important; color: #000 !important; }
        .status-rc { background-color: var(--bg-rc) !important; color: #fff !important; }
        .timer-remaining { color: #e74c3c; font-family: monospace; font-size: 1rem; }

        .log-entry { font-size: 0.8rem; padding: 6px 4px; border-bottom: 1px solid #eee; background: #fff; }
        .log-header { font-weight: bold; padding: 2px 4px; border-radius: 3px; margin-bottom: 2px; display: inline-block; }
        .log-yc { background-color: var(--bg-yc); color: #000; }
        .log-rc { background-color: var(--bg-rc); color: #fff; }
        .log-ofr { background-color: var(--bg-ofr); color: #000; }
        .log-default { color: #27ae60; }

        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        #player-picker { background: white; width: 340px; max-height: 80%; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; }
        .picker-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.1rem; }
        #uncontested-alert { color: #ff0000; font-weight: bold; display: none; font-size: 0.8rem; }
    </style>
</head>
<body id="drop-zone">

<header>
    <div class="header-top">
        <div id="team-name" style="font-weight:bold">Rugby Sub Manager</div>
        <div class="stopwatch-container">
            <div id="timer-display">00:00</div>
            <button class="sw-btn btn-start" onclick="timerStart()">START</button>
            <button class="sw-btn btn-pause" onclick="timerPause()">PAUSE</button>
            <button class="sw-btn btn-reset" onclick="timerReset()">RESET</button>
        </div>
        <div id="uncontested-alert">⚠️ アンコンテスト</div>
    </div>
    <div class="stats-bar">
        <span>FIELD: <b id="count-field">0</b></span>
        <span>Cat C: <b id="count-cat-c">0</b></span>
        <span>FR(F): <b id="count-fr">0</b></span>
        <span id="status-msg" style="margin-left:auto; opacity:0.7">Excelをドロップ</span>
    </div>
</header>

<main>
    <div class="col-field">
        <section class="column"><h2 style="color: var(--field-green);">FIELD</h2><div id="field-list" class="scroll-area"></div></section>
    </div>
    
    <div class="col-bench">
        <section class="column" id="bench-drop-target"><h2 style="color: var(--bench-orange);">BENCH</h2><div id="bench-list" class="scroll-area"></div></section>
    </div>

    <div class="col-res-admin">
        <section class="column" id="reserve-drop-area" style="flex: 1;"><h2>予約リスト</h2><div id="res-list" class="scroll-area"></div></section>
        <section class="column" style="flex: 1.5;"><h2>管理リスト</h2><div id="admin-list" class="scroll-area"></div></section>
    </div>

    <div class="col-log">
        <section class="column"><h2>LOG</h2><div id="log-list" class="scroll-area"></div></section>
    </div>
</main>

<div id="modal-overlay">
    <div id="player-picker">
        <h2 style="font-size: 1.1rem; padding: 15px; margin:0; background: #2c3e50; color:white; text-align:center;">ベンチ選手を選択</h2>
        <div id="picker-list" style="overflow-y:auto; flex-grow:1;"></div>
        <button onclick="closePicker()" style="padding:18px; border:none; background:#eee; font-weight:bold; font-size:1rem;">キャンセル</button>
    </div>
</div>

<script>
    let fieldPositions = Array.from({length: 15}, (_, i) => ({ posId: i + 1, player: null }));
    let benchPlayers = [];
    let reservations = [];
    let adminCards = [];
    let logs = [];
    let draggedData = null;

    let startTime = 0, elapsedTime = 0, timerInterval = null;
    function timerStart() { if (!timerInterval) { startTime = Date.now() - elapsedTime; timerInterval = setInterval(() => { elapsedTime = Date.now() - startTime; updateTimerDisplay(); processAdminTimers(); }, 100); } }
    function timerPause() { clearInterval(timerInterval); timerInterval = null; }
    function timerReset() { if (confirm("リセットしますか？")) { timerPause(); elapsedTime = 0; updateTimerDisplay(); } }
    function updateTimerDisplay() { document.getElementById('timer-display').innerText = getFormattedTime(); }
    function getFormattedTime() { const ts = Math.floor(elapsedTime / 1000); return `${Math.floor(ts/60).toString().padStart(2,'0')}:${(ts%60).toString().padStart(2,'0')}`; }

    function processAdminTimers() {
        if (!timerInterval) return;
        adminCards.forEach(card => {
            if (card.remainingSeconds > 0) {
                const passed = Math.floor((Date.now() - card.execRealTimestamp) / 1000);
                card.remainingSeconds = Math.max(0, card.totalSeconds - passed);
            }
        });
        renderAdminCards();
    }

    function addLog(typeName, p1, p2 = null) {
        logs.unshift({ time: getFormattedTime(), typeName, p1: {...p1}, p2: p2 ? {...p2} : null });
        renderLogs();
    }

    function renderLogs() {
        document.getElementById('log-list').innerHTML = logs.map(l => {
            let logCls = 'log-default';
            if (l.typeName === 'YC') logCls = 'log-yc';
            else if (l.typeName === 'RC') logCls = 'log-rc';
            else if (l.typeName === 'OFR') logCls = 'log-ofr';
            return `<div class="log-entry"><div class="log-header ${logCls}">[${l.time}] ${l.typeName}</div><div>${l.p2 ? 'OUT:' : ''} #${l.p1.no} ${l.p1.name}</div>${l.p2 ? `<div>IN: #${l.p2.no} ${l.p2.name}</div>` : ''}</div>`;
        }).join('');
    }

    const dropZone = document.getElementById('drop-zone');
    dropZone.addEventListener('dragover', (e) => e.preventDefault());
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const workbook = XLSX.read(new Uint8Array(ev.target.result), {type: 'array'});
                processExcel(XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1}));
            };
            reader.readAsArrayBuffer(file);
        }
    });

    function processExcel(data) {
        if (data[0] && data[0][2]) document.getElementById('team-name').innerText = data[0][2];
        const players = [];
        for (let i = 2; i < data.length; i++) {
            const row = data[i]; if (!row || !row[0]) continue;
            players.push({
                id: 'P' + row[0], no: parseInt(row[0]), name: String(row[1]||"").trim(),
                category: String(row[2]||"").trim(),
                fr: { fr1: String(row[3]).toLowerCase()==='true', fr2: String(row[4]).toLowerCase()==='true', fr3: String(row[5]).toLowerCase()==='true' },
                status: 'normal'
            });
        }
        fieldPositions = players.filter(p => p.no <= 15).map((p, idx) => ({ posId: idx + 1, player: p }));
        benchPlayers = players.filter(p => p.no > 15);
        render();
    }

    function sortBench() {
        benchPlayers.sort((a, b) => {
            const aIsCard = ['yc', 'rc', 'ofr'].includes(a.status);
            const bIsCard = ['yc', 'rc', 'ofr'].includes(b.status);
            if (aIsCard && !bIsCard) return 1;
            if (!aIsCard && bIsCard) return -1;
            return a.no - b.no;
        });
    }

    function getPlayerHTML(p) {
        if (!p) return '---';
        let frNumbers = [];
        if (p.fr.fr1) frNumbers.push("1");
        if (p.fr.fr2) frNumbers.push("2");
        if (p.fr.fr3) frNumbers.push("3");
        const frDisplay = frNumbers.length > 0 ? `<span class="player-fr-num">${frNumbers.join(',')}</span>` : '';
        const catDisplay = p.category ? `<span class="player-cat">[${p.category}]</span>` : '';
        
        return `
            <span class="jersey-no">#${p.no}</span>
            <span class="player-name">${p.name}</span>
            ${catDisplay}
            ${frDisplay}
        `;
    }

    function render() {
        sortBench(); renderField(); renderBench(); renderReservations(); renderAdminCards(); updateStats();
    }

    function renderField() {
        const list = document.getElementById('field-list'); list.innerHTML = '';
        fieldPositions.forEach(item => {
            const p = item.player;
            const isReserved = p ? reservations.some(r => r.out?.id === p.id || r.in?.id === p.id) : false;
            const div = document.createElement('div');
            div.className = `player-card ${isReserved ? 'is-reserved' : ''}`;
            div.innerHTML = `<div class="pos-label">${item.posId}</div><div class="player-info">${getPlayerHTML(p)}</div>`;
            if (p) {
                div.draggable = true;
                div.ondragstart = () => { draggedData = { source: 'field', data: item }; };
            }
            div.ondragover = (e) => e.preventDefault();
            div.ondrop = (e) => {
                e.preventDefault();
                if (draggedData?.source === 'bench') {
                    const inP = draggedData.data;
                    const cardType = (['yc', 'ofr', 'rc'].includes(inP.status)) ? inP.status.toUpperCase() : null;
                    if (cardType) reservations.push({ id: Date.now(), type: 'return', cardType: cardType, posId: item.posId, in: {...inP}, out: p ? {...p} : null });
                    else if (!reservations.some(r => r.in?.id === inP.id)) reservations.push({ id: Date.now(), type: 'sub', posId: item.posId, out: p ? {...p} : null, in: {...inP} });
                    render();
                }
            };
            list.appendChild(div);
        });
    }

    function renderBench() {
        const list = document.getElementById('bench-list'); list.innerHTML = '';
        benchPlayers.forEach(p => {
            const isReserved = reservations.some(r => r.in?.id === p.id || r.out?.id === p.id);
            const statusCls = ['yc','ofr','rc','injury'].includes(p.status) ? 'status-' + p.status : '';
            const div = document.createElement('div');
            div.className = `player-card ${isReserved ? 'is-reserved' : ''} ${statusCls}`;
            let textCls = '';
            if (['medical', 'blood'].includes(p.status)) textCls = 'status-medical';
            else if (p.status === 'tactical') textCls = 'status-tactical';
            div.innerHTML = `<div class="player-info ${textCls}">${getPlayerHTML(p)}</div>`;
            if (p.status !== 'injury') {
                div.draggable = true;
                div.ondragstart = () => { draggedData = { source: 'bench', data: p }; };
            }
            div.ondragover = (e) => { e.preventDefault(); e.stopPropagation(); };
            div.ondrop = (e) => {
                e.preventDefault(); e.stopPropagation();
                if (draggedData.source === 'field') {
                    const outP = draggedData.data.player;
                    if (outP && !reservations.some(r => r.out?.id === outP.id)) {
                        reservations.push({ id: Date.now(), type: 'sub', posId: draggedData.data.posId, out: {...outP}, in: {...p} });
                        render();
                    }
                } else if (draggedData.source === 'bench') {
                    const cardStatuses = ['yc','ofr','rc'];
                    if (cardStatuses.includes(p.status) || cardStatuses.includes(draggedData.data.status)) {
                        let cardP = cardStatuses.includes(p.status) ? p : draggedData.data;
                        let normP = cardStatuses.includes(p.status) ? draggedData.data : p;
                        const adminCard = adminCards.find(a => a.out.id === cardP.id);
                        if (adminCard) {
                            reservations.push({ id: Date.now(), type: 'card_sub_waiting', bloodType: cardP.status.toUpperCase(), posId: adminCard.posId, out: {...cardP}, in: {...normP} });
                            render();
                        }
                    }
                }
            };
            list.appendChild(div);
        });
    }

    const resArea = document.getElementById('reserve-drop-area');
    resArea.ondragover = (e) => e.preventDefault();
    resArea.ondrop = (e) => {
        e.preventDefault();
        if (draggedData?.source === 'field') {
            const p = draggedData.data.player;
            if (p && !reservations.some(r => r.out?.id === p.id)) {
                reservations.push({ id: Date.now(), type: 'card', posId: draggedData.data.posId, out: {...p} });
                render();
            }
        }
    };

    function renderReservations() {
        const list = document.getElementById('res-list'); list.innerHTML = '';
        reservations.forEach(res => {
            const card = document.createElement('div'); card.className = 'res-card';
            if (res.type === 'card_sub_waiting') {
                card.innerHTML = `<button class="btn-delete" onclick="cancelRes(${res.id})">×</button><div class="res-header"><span>${res.bloodType} 待機中</span></div><div class="res-player-line"><div class="line-row"><span class="line-label">OUT</span><span class="res-no">#${res.out.no}</span><span class="res-player-name">${res.out.name}</span></div><div class="line-row"><span class="line-label">IN</span><span class="res-no">#${res.in ? res.in.no : '--'}</span><span class="res-player-name">${res.in ? res.in.name : '未選択'}</span></div></div><div class="res-actions" style="grid-template-columns: 1fr 1fr;"><button style="color:var(--text-tactical)" onclick="executeCardWaitingSub(${res.id}, 'tactical')">戦術</button><button style="background:var(--bg-injury)" onclick="executeCardWaitingSub(${res.id}, 'injury')">負傷</button></div>`;
            } else if (res.type === 'sub') {
                card.innerHTML = `<button class="btn-delete" onclick="cancelRes(${res.id})">×</button><div class="res-header">POS ${res.posId} 交代予約</div><div class="res-player-line"><div class="line-row"><span class="line-label">OUT</span><span class="res-no">#${res.out?.no||'--'}</span><span class="res-player-name">${res.out?.name||'未選択'}</span></div><div class="line-row"><span class="line-label">IN</span><span class="res-no">#${res.in?.no||'--'}</span><span class="res-player-name">${res.in?.name||'未選択'}</span></div></div><div class="res-actions"><button style="color:var(--text-tactical)" onclick="executeSub(${res.id}, 'tactical', '戦術交代')">戦術</button><button style="background:var(--bg-injury)" onclick="executeSub(${res.id}, 'injury', '負傷交代')">負傷</button><button style="color:var(--text-medical)" onclick="moveToAdminBlood(${res.id}, '出血交代')">出血</button><button style="color:var(--text-medical)" onclick="moveToAdminBlood(${res.id}, 'HIA')">HIA</button><button style="color:var(--text-medical)" onclick="moveToAdminBlood(${res.id}, '出血HIA')">出血HIA</button><button onclick="executeSub(${res.id}, 'normal', '一時交代')">一時交代</button></div>`;
            } else if (res.type === 'blood_return') {
                card.innerHTML = `<button class="btn-delete" onclick="cancelRes(${res.id})">×</button><div class="res-header"><span>POS ${res.posId} ${res.bloodType}</span><span style="color:red">復帰待機</span></div><div class="res-player-line"><div class="line-row"><span class="line-label">復帰</span><span class="res-no">#${res.out.no}</span><span class="res-player-name">${res.out.name}</span></div><div class="line-row"><span class="line-label">種別</span><span>${res.subType}</span></div></div><button class="btn-execute-large" onclick="executeBloodReturn(${res.id})">実行</button>`;
            } else if (res.type === 'return') {
                card.innerHTML = `<button class="btn-delete" onclick="cancelRes(${res.id})">×</button><div class="res-header">POS ${res.posId} ${res.cardType}復帰</div><div class="res-player-line"><div class="line-row"><span class="line-label">IN</span><span class="res-no">#${res.in.no}</span><span class="res-player-name">${res.in.name}</span></div></div><button class="btn-execute-large" onclick="executeReturn(${res.id})">実行</button>`;
            } else {
                card.innerHTML = `<button class="btn-delete" onclick="cancelRes(${res.id})">×</button><div class="res-header">POS ${res.posId} 退場予約</div><div class="res-player-line"><div class="line-row"><span class="line-label">OUT</span><span class="res-no">#${res.out.no}</span><span class="res-player-name">${res.out.name}</span></div></div><div class="res-actions"><button style="background:#ffeb3b;" onclick="moveToAdminCard(${res.id}, 'YC')">YC</button><button style="background:#f44336;color:white;" onclick="moveToAdminCard(${res.id}, 'RC')">RC</button><button style="background:#ff9800;color:white;" onclick="moveToAdminCard(${res.id}, 'OFR')">OFR</button></div>`;
            }
            list.appendChild(card);
        });
    }

    function executeSub(resId, type, typeName) {
        const res = reservations.find(r => r.id === resId);
        if (!res.in) {
            const list = document.getElementById('picker-list'); list.innerHTML = '';
            benchPlayers.filter(p => !['yc','ofr','rc'].includes(p.status)).forEach(p => {
                const item = document.createElement('div'); item.className = 'picker-item';
                item.innerHTML = `<span>#${p.no}</span><span>${p.name}</span>`;
                item.onclick = () => { res.in = {...p}; closePicker(); executeSub(resId, type, typeName); };
                list.appendChild(item);
            });
            document.getElementById('modal-overlay').style.display = 'flex'; return;
        }
        const fPos = fieldPositions.find(p => p.posId === res.posId);
        const inIdx = benchPlayers.findIndex(p => p.id === res.in.id);
        if (inIdx !== -1) {
            if (res.out) benchPlayers[inIdx] = {...res.out, status: type};
            else benchPlayers.splice(inIdx, 1);
        }
        fPos.player = {...res.in, status: 'normal'};
        addLog(typeName, res.out || res.in, res.out ? res.in : null);
        reservations = reservations.filter(r => r.id !== resId);
        render();
    }

    function executeCardWaitingSub(resId, type) {
        const res = reservations.find(r => r.id === resId);
        if (!res.in) {
            const list = document.getElementById('picker-list'); list.innerHTML = '';
            benchPlayers.filter(p => !['yc','ofr','rc'].includes(p.status)).forEach(p => {
                const item = document.createElement('div'); item.className = 'picker-item';
                item.innerHTML = `<span>#${p.no}</span><span>${p.name}</span>`;
                item.onclick = () => { res.in = {...p}; closePicker(); executeCardWaitingSub(resId, type); };
                list.appendChild(item);
            });
            document.getElementById('modal-overlay').style.display = 'flex'; return;
        }
        const fPos = fieldPositions.find(p => p.posId === res.posId);
        benchPlayers = benchPlayers.filter(p => !(p.id === res.out.id && ['yc','rc','ofr'].includes(p.status)));
        const inIdx = benchPlayers.findIndex(p => p.id === res.in.id);
        if (inIdx !== -1) { benchPlayers[inIdx] = {...res.out, status: type}; }
        fPos.player = {...res.in, status: 'normal'};
        adminCards = adminCards.filter(a => a.out.id !== res.out.id);
        addLog(`退場中交代(${type==='tactical'?'戦術':'負傷'})`, res.out, res.in);
        reservations = reservations.filter(r => r.id !== resId);
        render();
    }

    function moveToAdminBlood(resId, typeName) {
        const res = reservations.find(r => r.id === resId);
        const fPos = fieldPositions.find(p => p.posId === res.posId);
        const now = new Date();
        adminCards.push({
            id: Date.now(), type: 'BLOOD', bloodType: typeName, gameTime: getFormattedTime(),
            pcTime: `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`,
            out: {...res.out}, in: {...res.in}, posId: res.posId,
            totalSeconds: 900, remainingSeconds: 900, execRealTimestamp: Date.now()
        });
        const bIdx = benchPlayers.findIndex(p => p.id === res.in.id);
        if(bIdx !== -1) benchPlayers[bIdx] = {...res.out, status: 'blood'};
        fPos.player = {...res.in, status: 'normal'};
        addLog(typeName, res.out, res.in);
        reservations = reservations.filter(r => r.id !== resId);
        render();
    }

    function executeBloodReturn(resId) {
        const res = reservations.find(r => r.id === resId);
        const fPos = fieldPositions.find(p => p.posId === res.posId);
        const currentIn = fPos.player;
        const bIdx = benchPlayers.findIndex(p => p.id === res.out.id);
        if (res.subType === '復帰') {
            fPos.player = {...res.out, status: 'normal'};
            if (bIdx !== -1) benchPlayers[bIdx] = {...currentIn, status: 'normal'};
        } else {
            if (bIdx !== -1) benchPlayers[bIdx].status = (res.subType === '戦術' ? 'tactical' : 'injury');
        }
        addLog(`出血復帰(${res.subType})`, res.out, res.in);
        reservations = reservations.filter(r => r.id !== resId);
        render();
    }

    function moveToAdminCard(resId, cardType) {
        const res = reservations.find(r => r.id === resId);
        const now = new Date();
        adminCards.push({
            id: Date.now(), type: cardType, gameTime: getFormattedTime(), pcTime: `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`,
            out: {...res.out}, posId: res.posId, totalSeconds: cardType === 'YC' ? 600 : (cardType === 'RC' ? 1200 : 0), remainingSeconds: cardType === 'YC' ? 600 : (cardType === 'RC' ? 1200 : 0), execRealTimestamp: Date.now()
        });
        benchPlayers.push({...res.out, status: cardType.toLowerCase()});
        fieldPositions.find(p => p.posId === res.posId).player = null;
        addLog(cardType, res.out);
        reservations = reservations.filter(r => r.id !== resId);
        render();
    }

    function executeReturn(resId) {
        const res = reservations.find(r => r.id === resId);
        benchPlayers = benchPlayers.filter(p => !(p.id === res.in.id && ['yc','rc','ofr'].includes(p.status)));
        fieldPositions.find(p => p.posId === res.posId).player = {...res.in, status: 'normal'};
        addLog(`${res.cardType}復帰`, res.in);
        reservations = reservations.filter(r => r.id !== resId);
        render();
    }

    function renderAdminCards() {
        const list = document.getElementById('admin-list'); list.innerHTML = '';
        adminCards.forEach(card => {
            const div = document.createElement('div'); div.className = 'admin-card';
            const m = Math.floor(card.remainingSeconds / 60), s = card.remainingSeconds % 60;
            if (card.type === 'BLOOD') {
                div.innerHTML = `<button class="btn-delete" onclick="adminDelete(${card.id})">×</button><div class="res-header"><span>${card.bloodType}</span><span class="timer-remaining">${m}:${s.toString().padStart(2,'0')}</span></div><div class="res-player-line" style="font-size:0.85rem">OUT: #${card.out.no} / IN: #${card.in.no}</div><div class="res-actions"><button onclick="bloodToReserve(${card.id}, '復帰')">復帰</button><button onclick="bloodToReserve(${card.id}, '戦術')">戦術</button><button onclick="bloodToReserve(${card.id}, '負傷')">負傷</button></div>`;
            } else {
                div.innerHTML = `<button class="btn-delete" onclick="adminDelete(${card.id})">×</button><div class="res-header"><span>${card.type}</span><span class="timer-remaining">${m}:${s.toString().padStart(2,'0')}</span></div><div class="res-player-line" style="font-size:0.85rem">OUT: #${card.out.no} ${card.out.name}</div><div class="res-actions" style="grid-template-columns: 1fr 1fr;"><button onclick="adminAction(${card.id}, 'return')">復帰</button><button onclick="adminAction(${card.id}, 'tactical')">戦術</button></div>`;
            }
            list.appendChild(div);
        });
    }

    function adminAction(adminId, actionType) {
        const card = adminCards.find(a => a.id === adminId);
        if (actionType === 'return') reservations.push({ id: Date.now(), type: 'return', cardType: card.type, posId: card.posId, in: card.out });
        else reservations.push({ id: Date.now(), type: 'card_sub_waiting', bloodType: card.type, posId: card.posId, out: card.out, in: null });
        adminCards = adminCards.filter(a => a.id !== adminId);
        render();
    }

    function bloodToReserve(adminId, subType) {
        const card = adminCards.find(a => a.id === adminId);
        reservations.push({ id: Date.now(), type: 'blood_return', posId: card.posId, bloodType: card.bloodType, subType: subType, out: card.out, in: card.in });
        adminCards = adminCards.filter(a => a.id !== adminId);
        render();
    }

    function cancelRes(id) { reservations = reservations.filter(r => r.id !== id); render(); }
    function adminDelete(id) { if(confirm("管理カードを削除しますか？")) { adminCards = adminCards.filter(a => a.id !== id); render(); } }
    function closePicker() { document.getElementById('modal-overlay').style.display = 'none'; }
    function updateStats() {
        const onField = fieldPositions.map(p => p.player).filter(p => p);
        document.getElementById('count-field').innerText = onField.length;
        document.getElementById('count-cat-c').innerText = onField.filter(p => p.category.includes('C')).length;
        document.getElementById('count-fr').innerText = onField.filter(p => p.fr.fr1 || p.fr.fr2 || p.fr.fr3).length;
        const p1 = fieldPositions.find(p => p.posId === 1)?.player, p2 = fieldPositions.find(p => p.posId === 2)?.player, p3 = fieldPositions.find(p => p.posId === 3)?.player;
        document.getElementById('uncontested-alert').style.display = (p1?.fr.fr1 && p2?.fr.fr2 && p3?.fr.fr3) ? 'none' : 'block';
    }
</script>
</body>
</html>
